<!--
  Navigation Component
  Reusable navigation menu component with two-level dropdown support
  Manages interaction state using Alpine.js
-->

<nav
    x-data="navigationMenu()"
    class="main-nav"
    role="navigation"
    aria-label="Main navigation"
>
    <!-- Desktop Navigation -->
    <ul class="nav-menu desktop-nav">
        {% for item in navigation %}
            {% if not item.parent_id %}
                {% set has_children = navigation|selectattr('parent_id', 'equalto', item.id)|list %}
                <li
                    class="nav-item{% if has_children %} has-dropdown{% endif %}"
                    {% if has_children %}
                    x-data="{ open: false, closeTimeout: null }"
                    @mouseenter="clearTimeout(closeTimeout); open = true"
                    @mouseleave="closeTimeout = setTimeout(() => { open = false }, 600)"
                    {% endif %}
                >
                    <a
                        href="{% if item.slug == 'home' %}/en/{% else %}/en/{{ item.slug }}/{% endif %}"
                        class="nav-link{% if column and column.id == item.id %} active{% endif %}"
                        {% if has_children %}
                        :aria-expanded="open.toString()"
                        {% endif %}
                    >
                        {{ item|column_name }}
                        {% if has_children %}
                        <svg
                            class="dropdown-icon"
                            width="12"
                            height="12"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            :class="{ 'rotate-180': open }"
                            style="transition: transform 0.2s;"
                        >
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        {% endif %}
                    </a>
                    {% if has_children %}
                    <ul
                        class="dropdown-menu"
                        x-show="open"
                        x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 transform scale-95"
                        x-transition:enter-end="opacity-100 transform scale-100"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 transform scale-100"
                        x-transition:leave-end="opacity-0 transform scale-95"
                        @click.away="open = false"
                        style="display: none;"
                        x-cloak
                    >
                        {% for child in has_children %}
                        <li>
                            <a href="/en/{{ child.slug }}/" class="dropdown-item">
                                {{ child|column_name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </li>
            {% endif %}
        {% endfor %}
    </ul>

    <!-- Mobile Menu Toggle -->
    <button
        class="mobile-menu-toggle"
        @click="toggleMobileMenu()"
        type="button"
        aria-expanded="false"
        x-bind:aria-expanded="mobileMenuOpen.toString()"
        aria-controls="mobile-menu-panel"
        aria-label="Menu"
    >
        <span class="hamburger-line" :class="{ 'active': mobileMenuOpen }"></span>
        <span class="hamburger-line" :class="{ 'active': mobileMenuOpen }"></span>
        <span class="hamburger-line" :class="{ 'active': mobileMenuOpen }"></span>
    </button>

    <!-- Mobile Menu -->
    <div
        class="mobile-menu"
        x-show="mobileMenuOpen"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 max-h-0"
        x-transition:enter-end="opacity-100 max-h-menu"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 max-h-menu"
        x-transition:leave-end="opacity-0 max-h-0"
        style="display: none; overflow: hidden;"
        x-cloak
        id="mobile-menu-panel"
        role="dialog"
        aria-modal="true"
        aria-hidden="true"
    >
        <div class="mobile-nav">
            <button class="mobile-nav-toggle mobile-nav-close" type="button" @click="closeMobileMenu()" aria-label="Close">Close</button>
            <ul class="mobile-nav-menu">
                {% for item in navigation %}
                    {% if not item.parent_id %}
                        {% set has_children = navigation|selectattr('parent_id', 'equalto', item.id)|list %}
                        <li
                            class="mobile-nav-item{% if has_children %} has-submenu{% endif %}"
                            x-data="{ submenuOpen: false }"
                        >
                            {% if has_children %}
                            <button
                                class="mobile-nav-toggle"
                                type="button"
                                @click="submenuOpen = !submenuOpen"
                                aria-expanded="false"
                                x-bind:aria-expanded="submenuOpen.toString()"
                            >
                                <span>{{ item|column_name }}</span>
                                <svg
                                    class="toggle-icon"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    :class="{ 'rotate-180': submenuOpen }"
                                    style="transition: transform 0.2s;"
                                >
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <ul
                                class="mobile-submenu"
                                x-show="submenuOpen"
                                x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 max-h-0"
                                x-transition:enter-end="opacity-100 max-h-96"
                                x-transition:leave="transition ease-in duration-150"
                                x-transition:leave-start="opacity-100 max-h-96"
                                x-transition:leave-end="opacity-0 max-h-0"
                                style="display: none; overflow: hidden;"
                                x-cloak
                                aria-hidden="true"
                            >
                                <!-- Link to parent overview page -->
                                <li>
                                    <a href="{% if item.slug == 'home' %}/en/{% else %}/en/{{ item.slug }}/{% endif %}" class="mobile-submenu-link parent-link">
                                        <strong>View All {{ item|column_name }}</strong>
                                    </a>
                                </li>
                                {% for child in has_children %}
                                <li>
                                    <a href="/en/{{ child.slug }}/" class="mobile-submenu-link">
                                        {{ child|column_name }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <a href="{% if item.slug == 'home' %}/en/{% else %}/en/{{ item.slug }}/{% endif %}" class="mobile-nav-link">
                                {{ item|column_name }}
                            </a>
                            {% endif %}
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
            <div class="mobile-nav-footer">
                <a href="/en/contact/" class="btn btn-primary btn-block">Contact Us</a>
            </div>
        </div>
    </div>

    
</nav>

<script>
/**
 * Navigation Menu Alpine.js Component
 * Manages navigation menu state and interaction
 */
function navigationMenu() {
    return {
        // Mobile menu open/close state
        mobileMenuOpen: false,
        lastFocused: null,

        /**
         * Toggle mobile menu
         */
        toggleMobileMenu() {
            this.mobileMenuOpen = !this.mobileMenuOpen;
            // Toggle body class to disable scrolling
            document.body.classList.toggle('mobile-menu-open', this.mobileMenuOpen);
            if (this.mobileMenuOpen) {
                this.lastFocused = document.activeElement;
                const panel = document.getElementById('mobile-menu-panel');
                const focusables = panel ? panel.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])') : [];
                if (focusables.length) focusables[0].focus();
            } else if (this.lastFocused) {
                this.lastFocused.focus();
            }
        },

        /**
         * Close mobile menu
         */
        closeMobileMenu() {
            this.mobileMenuOpen = false;
            document.body.classList.remove('mobile-menu-open');
            if (this.lastFocused) this.lastFocused.focus();
        },

        /**
         * Initialize
         */
        init() {
            // Listen for ESC key to close mobile menu
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.mobileMenuOpen) {
                    this.closeMobileMenu();
                }
                if (e.key === 'Tab' && this.mobileMenuOpen) {
                    const panel = document.getElementById('mobile-menu-panel');
                    const focusables = panel ? Array.from(panel.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])')) : [];
                    if (focusables.length) {
                        const first = focusables[0];
                        const last = focusables[focusables.length - 1];
                        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                    }
                }
            });

            // Listen for route changes to close mobile menu
            window.addEventListener('popstate', () => {
                this.closeMobileMenu();
            });
        }
    };
}
</script>

<style>
/* Alpine.js cloak - Prevent content flash */
[x-cloak] { display: none !important; }

/* Dropdown menu animation helper */
.dropdown-menu {
    transform-origin: top;
}

.mobile-submenu {
    transform-origin: top;
}

/* Hamburger menu animation */
.hamburger-line {
    transition: all 0.3s ease;
}

.hamburger-line.active:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
}

.hamburger-line.active:nth-child(2) {
    opacity: 0;
}

.hamburger-line.active:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -7px);
}

/* Disable body scroll */
body.mobile-menu-open {
    overflow: hidden;
}
</style>
