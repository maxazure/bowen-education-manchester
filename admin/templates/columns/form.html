{% extends "base.html" %}

{% block title %}{% if mode == 'edit' %}编辑栏目{% else %}新建栏目{% endif %} - 博文教育管理后台{% endblock %}

{% block content %}
<div class="form-container">
    <!-- 页面标题 -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title mb-1">
                <i class="bi bi-{% if mode == 'edit' %}pencil-square{% else %}plus-circle{% endif %} me-2"></i>
                {% if mode == 'edit' %}编辑栏目{% else %}新建栏目{% endif %}
            </h1>
            <p class="page-subtitle mb-0">
                {% if mode == 'edit' %}
                更新栏目信息和配置
                {% else %}
                创建一个新的栏目内容
                {% endif %}
            </p>
        </div>
        <div>
            <a href="/admin/columns" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </div>

    <!-- 表单内容 -->
    <form method="POST" action="{% if mode == 'edit' %}/admin/columns/{{ column.id }}{% else %}/admin/columns{% endif %}" id="columnForm" class="needs-validation" novalidate>
        <div class="form-layout">
            <!-- 左侧主要内容 -->
            <div class="form-main">
                <!-- 基本信息卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle me-2"></i>基本信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- 栏目名称 -->
                            <div class="col-md-6">
                                <label for="name" class="form-label">
                                    栏目名称 <span class="text-danger">*</span>
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="name"
                                    name="name"
                                    value="{% if column %}{{ column.name }}{% endif %}"
                                    required
                                    placeholder="例如：关于我们">
                                <div class="invalid-feedback">
                                    请输入栏目名称
                                </div>
                            </div>

                            <!-- URL Slug -->
                            <div class="col-md-6">
                                <label for="slug" class="form-label">
                                    URL Slug
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="slug"
                                    name="slug"
                                    value="{% if column %}{{ column.slug }}{% endif %}"
                                    placeholder="留空自动生成">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>URL 友好的标识符，如 about-us</span>
                                </div>
                            </div>

                            <!-- 栏目类型 -->
                            <div class="col-md-6">
                                <label for="column_type" class="form-label">
                                    栏目类型 <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="column_type" name="column_type" required>
                                    <option value="">请选择</option>
                                    <option value="SINGLE_PAGE" {% if column and column.column_type.value == 'SINGLE_PAGE' %}selected{% endif %}>
                                        单页面
                                    </option>
                                    <option value="POST" {% if column and column.column_type.value == 'POST' %}selected{% endif %}>
                                        文章栏目
                                    </option>
                                    <option value="PRODUCT" {% if column and column.column_type.value == 'PRODUCT' %}selected{% endif %}>
                                        产品栏目
                                    </option>
                                    <option value="GALLERY" {% if column and column.column_type.value == 'GALLERY' %}selected{% endif %}>
                                        相册模块
                                    </option>
                                    <option value="CUSTOM" {% if column and column.column_type.value == 'CUSTOM' %}selected{% endif %}>
                                        自定义模块
                                    </option>
                                </select>
                                <div class="invalid-feedback">
                                    请选择栏目类型
                                </div>
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>决定栏目的内容类型和展示方式</span>
                                </div>
                            </div>

                            <!-- 排序值 -->
                            <div class="col-md-6">
                                <label for="sort_order" class="form-label">
                                    排序值
                                </label>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="sort_order"
                                    name="sort_order"
                                    value="{% if column %}{{ column.sort_order }}{% else %}0{% endif %}"
                                    min="0">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>数字越小越靠前显示</span>
                                </div>
                            </div>

                            <!-- 栏目描述 -->
                            <div class="col-12">
                                <label for="description" class="form-label">
                                    栏目描述
                                </label>
                                <textarea
                                    class="form-control"
                                    id="description"
                                    name="description"
                                    rows="3"
                                    placeholder="简要描述栏目内容">{% if column %}{{ column.description or '' }}{% endif %}</textarea>
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>也可作为 Hero 区域的副标题</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hero 区域卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-image me-2"></i>Hero 区域配置
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Hero 主标题 -->
                            <div class="col-12">
                                <label for="hero_title" class="form-label">
                                    Hero 主标题
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="hero_title"
                                    name="hero_title"
                                    value="{% if column %}{{ column.hero_title or '' }}{% endif %}"
                                    placeholder="例如：欢迎来到博文教育">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>页面顶部显示的主标题（中文）</span>
                                </div>
                            </div>

                            <!-- Hero 英文副标题 -->
                            <div class="col-12">
                                <label for="hero_title_en" class="form-label">
                                    Hero 英文副标题
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="hero_title_en"
                                    name="hero_title_en"
                                    value="{% if column %}{{ column.hero_title_en or '' }}{% endif %}"
                                    placeholder="例如：Welcome to Bowen Education">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>英文标题或副标题</span>
                                </div>
                            </div>

                            <!-- Hero 标语 -->
                            <div class="col-12">
                                <label for="hero_tagline" class="form-label">
                                    Hero 标语/口号
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="hero_tagline"
                                    name="hero_tagline"
                                    value="{% if column %}{{ column.hero_tagline or '' }}{% endif %}"
                                    placeholder="例如：专业、创新、卓越">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>简短的品牌口号或宣传语</span>
                                </div>
                            </div>

                            <!-- CTA 按钮文字 -->
                            <div class="col-md-6">
                                <label for="hero_cta_text" class="form-label">
                                    CTA 按钮文字
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="hero_cta_text"
                                    name="hero_cta_text"
                                    value="{% if column %}{{ column.hero_cta_text or '' }}{% endif %}"
                                    placeholder="例如：了解更多">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>行动号召按钮的显示文字</span>
                                </div>
                            </div>

                            <!-- CTA 按钮链接 -->
                            <div class="col-md-6">
                                <label for="hero_cta_url" class="form-label">
                                    CTA 按钮链接
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="hero_cta_url"
                                    name="hero_cta_url"
                                    value="{% if column %}{{ column.hero_cta_url or '' }}{% endif %}"
                                    placeholder="例如：/about">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>按钮点击后的跳转地址</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 高级设置卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear me-2"></i>高级设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- 父栏目 -->
                            <div class="col-12">
                                <label for="parent_id" class="form-label">
                                    父栏目
                                </label>
                                <select class="form-select" id="parent_id" name="parent_id">
                                    <option value="">无（顶级栏目）</option>
                                    {% for col in all_columns %}
                                        {% if not column or col.id != column.id %}
                                            <option value="{{ col.id }}"
                                                    {% if column and column.parent_id == col.id %}selected{% endif %}>
                                                {% if col.parent_id %}└─ {% endif %}{{ col.name }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>设置为其他栏目的子栏目，建立层级关系</span>
                                </div>
                            </div>

                            <!-- 菜单位置 -->
                            <div class="col-md-6">
                                <label for="menu_location" class="form-label">
                                    菜单位置
                                </label>
                                <select class="form-select" id="menu_location" name="menu_location">
                                    <option value="header" {% if column and column.menu_location == 'header' %}selected{% endif %}>
                                        顶部导航
                                    </option>
                                    <option value="footer" {% if column and column.menu_location == 'footer' %}selected{% endif %}>
                                        底部菜单
                                    </option>
                                    <option value="both" {% if column and column.menu_location == 'both' %}selected{% endif %}>
                                        顶部和底部
                                    </option>
                                    <option value="none" {% if column and column.menu_location == 'none' %}selected{% endif %}>
                                        不显示
                                    </option>
                                </select>
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>栏目在网站中的显示位置</span>
                                </div>
                            </div>

                            <!-- 图标类名 -->
                            <div class="col-md-6">
                                <label for="icon" class="form-label">
                                    图标类名
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi {% if column and column.icon %}{{ column.icon }}{% else %}bi-file-text{% endif %}"
                                           id="icon-preview"></i>
                                    </span>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="icon"
                                        name="icon"
                                        value="{% if column %}{{ column.icon or '' }}{% endif %}"
                                        placeholder="例如：bi-house">
                                </div>
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>Bootstrap Icons 图标类名，
                                        <a href="https://icons.getbootstrap.com/" target="_blank">查看图标库</a>
                                    </span>
                                </div>
                            </div>

                            <!-- 显示控制 -->
                            <div class="col-12">
                                <label class="form-label d-block">显示控制</label>

                                <div class="form-check form-switch mb-3">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        id="show_in_nav"
                                        name="show_in_nav"
                                        value="true"
                                        {% if not column or column.show_in_nav %}checked{% endif %}>
                                    <label class="form-check-label" for="show_in_nav">
                                        <i class="bi bi-menu-button-wide text-primary me-1"></i>显示在导航栏
                                    </label>
                                </div>

                                <div class="form-check form-switch mb-0">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        id="is_enabled"
                                        name="is_enabled"
                                        value="true"
                                        {% if not column or column.is_enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="is_enabled">
                                        <i class="bi bi-toggle-on text-success me-1"></i>启用栏目
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 表单操作按钮 -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>
                        {% if mode == 'edit' %}更新栏目{% else %}创建栏目{% endif %}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/columns'">
                        <i class="bi bi-x-circle me-2"></i>
                        取消
                    </button>
                </div>
            </div>

            <!-- 右侧侧边栏 -->
            <div class="form-sidebar">
                <!-- 帮助信息 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-question-circle me-2"></i>帮助信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">
                                <i class="bi bi-list-ul"></i>
                                <span>栏目类型说明</span>
                            </div>
                            <ul class="small text-muted mb-0" style="padding-left: 20px;">
                                <li style="margin-bottom: 8px;"><strong>单页面：</strong>适合固定内容，如关于我们</li>
                                <li style="margin-bottom: 8px;"><strong>文章栏目：</strong>用于新闻、博客等列表</li>
                                <li style="margin-bottom: 8px;"><strong>产品栏目：</strong>用于产品展示</li>
                                <li style="margin-bottom: 8px;"><strong>相册模块：</strong>用于图片展示</li>
                                <li style="margin-bottom: 0;"><strong>自定义模块：</strong>特殊功能页面</li>
                            </ul>
                        </div>

                        <div class="sidebar-section mb-0">
                            <div class="sidebar-section-title">
                                <i class="bi bi-link-45deg"></i>
                                <span>URL Slug 规则</span>
                            </div>
                            <ul class="small text-muted mb-0" style="padding-left: 20px;">
                                <li style="margin-bottom: 8px;">只能包含小写字母、数字和连字符</li>
                                <li style="margin-bottom: 8px;">不能以连字符开头或结尾</li>
                                <li style="margin-bottom: 0;">留空将自动从栏目名称生成</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 栏目信息（编辑模式） -->
                {% if mode == 'edit' and column %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle me-2"></i>栏目信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-section mb-0">
                            <div class="small">
                                <div class="mb-2">
                                    <span class="text-muted">创建时间：</span>
                                    <br>{{ column.created_at.strftime('%Y-%m-%d %H:%M') }}
                                </div>
                                <div>
                                    <span class="text-muted">更新时间：</span>
                                    <br>{{ column.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    // Slug 自动生成
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');
    const isEditMode = {{ 'true' if mode == 'edit' else 'false' }};

    if (!isEditMode && nameInput && slugInput) {
        nameInput.addEventListener('input', function() {
            if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
                const slug = generateSlug(nameInput.value);
                slugInput.value = slug;
                slugInput.dataset.autoGenerated = 'true';
            }
        });

        // 用户手动修改 slug 时，停止自动生成
        slugInput.addEventListener('input', function() {
            if (slugInput.value) {
                slugInput.dataset.autoGenerated = 'false';
            }
        });
    }

    /**
     * 生成 URL Slug
     */
    function generateSlug(text) {
        return text
            .toLowerCase()
            .trim()
            .replace(/\s+/g, '-')        // 空格替换为连字符
            .replace(/[^\w\-]+/g, '')    // 移除非单词字符
            .replace(/\-\-+/g, '-')      // 多个连字符替换为单个
            .replace(/^-+/, '')          // 去除开头的连字符
            .replace(/-+$/, '');         // 去除结尾的连字符
    }

    // 图标预览
    const iconInput = document.getElementById('icon');
    const iconPreview = document.getElementById('icon-preview');

    if (iconInput && iconPreview) {
        iconInput.addEventListener('input', function() {
            const iconClass = iconInput.value.trim();
            if (iconClass) {
                iconPreview.className = 'bi ' + iconClass;
            } else {
                iconPreview.className = 'bi bi-file-text';
            }
        });
    }

    // Bootstrap 表单验证
    const form = document.getElementById('columnForm');

    if (form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();

            // 验证表单
            if (!form.checkValidity()) {
                form.classList.add('was-validated');

                // 显示错误提示
                showToast('danger', '请填写所有必填字段', '表单验证失败');
                return;
            }

            // 提交表单
            submitForm();
        });
    }

    // AJAX 提交表单
    function submitForm() {
        const formData = new FormData(form);

        // 处理复选框值
        formData.set('show_in_nav', document.getElementById('show_in_nav').checked);
        formData.set('is_enabled', document.getElementById('is_enabled').checked);

        // 显示加载状态
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message, '成功');

                // 延迟跳转到列表页
                setTimeout(() => {
                    window.location.href = '/columns';
                }, 1500);
            } else {
                showToast('danger', data.message, '错误');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('danger', '提交失败: ' + error.message, '错误');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }

    // 栏目类型提示
    const columnTypeSelect = document.getElementById('column_type');
    if (columnTypeSelect) {
        const typeDescriptions = {
            'SINGLE_PAGE': '单页面适合展示固定内容，如"关于我们"、"联系我们"等。',
            'POST': '文章栏目用于展示新闻、博客等动态内容列表。',
            'PRODUCT': '产品栏目用于展示和管理产品信息。',
            'GALLERY': '相册模块用于图片集展示，支持图片浏览功能。',
            'CUSTOM': '自定义模块用于特殊功能页面，需要单独开发。'
        };

        columnTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            const description = typeDescriptions[selectedType];

            if (description) {
                const helpText = this.parentElement.querySelector('.help-text span');
                if (helpText) {
                    helpText.textContent = description;
                }
            }
        });
    }

    // 防止意外离开页面
    let formChanged = false;

    form.addEventListener('change', function() {
        formChanged = true;
    });

    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    // 表单提交后清除警告
    form.addEventListener('submit', function() {
        formChanged = false;
    });

})();
</script>
{% endblock %}
