{% extends "base.html" %}

{% block title %}系统监控 - 博文教育管理后台{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .stat-card .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .stat-card .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #333;
    }

    .stat-card .stat-label {
        color: #666;
        font-size: 14px;
    }

    .progress-thin {
        height: 8px;
        border-radius: 4px;
        background: #f0f0f0;
        overflow: hidden;
    }

    .progress-bar-thin {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .health-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }

    .health-healthy {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }

    .health-warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }

    .health-critical {
        background: linear-gradient(135deg, #ff6b6b 0%, #c23616 100%);
        color: white;
    }

    .service-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-radius: 10px;
        background: white;
        margin-bottom: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .service-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        margin-right: 15px;
    }

    .service-running {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }

    .service-stopped {
        background: linear-gradient(135deg, #ff6b6b 0%, #c23616 100%);
        color: white;
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .metric-row:last-child {
        border-bottom: none;
    }

    .metric-label {
        color: #666;
        font-size: 14px;
    }

    .metric-value {
        font-weight: 600;
        color: #333;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    .status-online {
        background: #43e97b;
    }

    .status-offline {
        background: #ff6b6b;
        animation: none;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">系统监控</h4>
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin/">首页</a></li>
                    <li class="breadcrumb-item active">系统监控</li>
                </ol>
            </nav>
        </div>
        <div>
            <span class="health-badge health-healthy" id="overallStatus">
                <span class="status-indicator status-online"></span>
                系统正常
            </span>
        </div>
    </div>

    <!-- 实时状态卡片 -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-value" id="cpuValue">0%</div>
                            <div class="stat-label text-white-50">CPU 使用率</div>
                        </div>
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="bi bi-cpu"></i>
                        </div>
                    </div>
                    <div class="progress-thin mt-3">
                        <div class="progress-bar-thin" id="cpuProgress" style="width: 0%; background: rgba(255,255,255,0.8);"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-value" id="memoryValue">0%</div>
                            <div class="stat-label text-white-50">内存使用率</div>
                        </div>
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="bi bi-memory"></i>
                        </div>
                    </div>
                    <div class="progress-thin mt-3">
                        <div class="progress-bar-thin" id="memoryProgress" style="width: 0%; background: rgba(255,255,255,0.8);"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-value" id="diskValue">0%</div>
                            <div class="stat-label text-white-50">磁盘使用率</div>
                        </div>
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="bi bi-hdd"></i>
                        </div>
                    </div>
                    <div class="progress-thin mt-3">
                        <div class="progress-bar-thin" id="diskProgress" style="width: 0%; background: rgba(255,255,255,0.8);"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-value" id="dbTime">--</div>
                            <div class="stat-label text-white-50">数据库响应</div>
                        </div>
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="bi bi-database"></i>
                        </div>
                    </div>
                    <div class="mt-3 small">
                        <i class="bi bi-clock me-1"></i>
                        <span id="lastUpdate">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- 资源使用详情 -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-4">
                    <i class="bi bi-pie-chart me-2"></i>资源使用详情
                </h5>
                <div class="metric-row">
                    <span class="metric-label">CPU 核心数</span>
                    <span class="metric-value" id="cpuCores">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">CPU 使用率</span>
                    <span class="metric-value" id="cpuPercent">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">内存总量</span>
                    <span class="metric-value" id="memoryTotal">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">已用内存</span>
                    <span class="metric-value" id="memoryUsed">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">可用内存</span>
                    <span class="metric-value" id="memoryAvailable">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">磁盘总量</span>
                    <span class="metric-value" id="diskTotal">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">已用磁盘</span>
                    <span class="metric-value" id="diskUsed">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">可用磁盘</span>
                    <span class="metric-value" id="diskFree">--</span>
                </div>
            </div>
        </div>

        <!-- 服务状态 -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-4">
                    <i class="bi bi-gear me-2"></i>服务状态
                </h5>
                <div id="servicesList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 历史图表 -->
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>资源使用历史（30分钟）
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshHistory()">
                        <i class="bi bi-arrow-clockwise me-1"></i>刷新
                    </button>
                </div>
                <canvas id="historyChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    let historyChart = null;
    let refreshInterval = null;

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadHealthData();
        loadServices();
        loadHistory();
        initChart();

        // 定时刷新
        refreshInterval = setInterval(() => {
            loadHealthData();
        }, 3000);
    });

    // 加载健康数据
    async function loadHealthData() {
        try {
            const response = await fetch('/api/health');
            const result = await response.json();

            if (result.success) {
                const data = result.data;
                updateHealthDisplay(data);
            }
        } catch (error) {
            console.error('加载健康数据失败:', error);
        }
    }

    // 更新健康状态显示
    function updateHealthDisplay(data) {
        const system = data.system;
        const db = data.database;

        // 更新CPU
        document.getElementById('cpuValue').textContent = system.cpu_percent.toFixed(1) + '%';
        document.getElementById('cpuProgress').style.width = system.cpu_percent + '%';
        document.getElementById('cpuPercent').textContent = system.cpu_percent.toFixed(1) + '%';

        // 更新内存
        document.getElementById('memoryValue').textContent = system.memory_percent.toFixed(1) + '%';
        document.getElementById('memoryProgress').style.width = system.memory_percent + '%';
        document.getElementById('memoryTotal').textContent = system.memory.total_gb + ' GB';
        document.getElementById('memoryUsed').textContent = system.memory.used_gb.toFixed(1) + ' GB';
        document.getElementById('memoryAvailable').textContent = system.memory.available_gb.toFixed(1) + ' GB';

        // 更新磁盘
        document.getElementById('diskValue').textContent = system.disk_usage.percent + '%';
        document.getElementById('diskProgress').style.width = system.disk_usage.percent + '%';
        document.getElementById('diskTotal').textContent = system.disk_usage.total_gb + ' GB';
        document.getElementById('diskUsed').textContent = system.disk_usage.used_gb.toFixed(1) + ' GB';
        document.getElementById('diskFree').textContent = system.disk_usage.free_gb.toFixed(1) + ' GB';

        // 更新CPU核心数
        document.getElementById('cpuCores').textContent = navigator.hardwareConcurrency || '--';

        // 更新数据库状态
        if (db.query_time_ms !== null) {
            document.getElementById('dbTime').textContent = db.query_time_ms + 'ms';
        } else {
            document.getElementById('dbTime').textContent = '超时';
        }

        // 更新时间
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

        // 更新总体状态
        const overallStatus = document.getElementById('overallStatus');
        if (data.overall_status === 'healthy') {
            overallStatus.className = 'health-badge health-healthy';
            overallStatus.innerHTML = '<span class="status-indicator status-online"></span>系统正常';
        } else {
            overallStatus.className = 'health-badge health-warning';
            overallStatus.innerHTML = '<span class="status-indicator status-online"></span>系统警告';
        }
    }

    // 加载服务状态
    async function loadServices() {
        try {
            const response = await fetch('/api/services');
            const result = await response.json();

            if (result.success) {
                renderServices(result.data);
            }
        } catch (error) {
            console.error('加载服务状态失败:', error);
        }
    }

    // 渲染服务列表
    function renderServices(services) {
        const container = document.getElementById('servicesList');

        container.innerHTML = services.map(service => `
            <div class="service-item">
                <div class="service-icon ${service.status === 'running' ? 'service-running' : 'service-stopped'}">
                    <i class="bi ${service.status === 'running' ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold">${service.name}</div>
                    <div class="small text-muted">${service.description}</div>
                </div>
                <div>
                    <span class="badge ${service.status === 'running' ? 'bg-success' : 'bg-danger'}">
                        ${service.status === 'running' ? '运行中' : '已停止'}
                    </span>
                    ${service.port ? `<span class="text-muted ms-2">:${service.port}</span>` : ''}
                </div>
            </div>
        `).join('');
    }

    // 加载历史数据
    async function loadHistory() {
        try {
            const response = await fetch('/api/health/history?minutes=30');
            const result = await response.json();

            if (result.success) {
                updateChart(result.data);
            }
        } catch (error) {
            console.error('加载历史数据失败:', error);
        }
    }

    // 刷新历史数据
    function refreshHistory() {
        loadHistory();
    }

    // 初始化图表
    function initChart() {
        const ctx = document.getElementById('historyChart').getContext('2d');

        historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'CPU',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: '内存',
                        data: [],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: '磁盘',
                        data: [],
                        borderColor: '#43e97b',
                        backgroundColor: 'rgba(67, 233, 123, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                animation: {
                    duration: 500
                }
            }
        });
    }

    // 更新图表数据
    function updateChart(data) {
        const labels = data.map(d => {
            const time = new Date(d.timestamp);
            return time.getHours().toString().padStart(2, '0') + ':' +
                   time.getMinutes().toString().padStart(2, '0');
        });

        historyChart.data.labels = labels;
        historyChart.data.datasets[0].data = data.map(d => d.cpu);
        historyChart.data.datasets[1].data = data.map(d => d.memory);
        historyChart.data.datasets[2].data = data.map(d => d.disk);
        historyChart.update();
    }

    // 页面离开时清除定时器
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %}
