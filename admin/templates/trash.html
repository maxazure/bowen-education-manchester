{% extends "base.html" %}

{% block title %}回收站 - 博文教育管理后台{% endblock %}

{% block content %}
<!-- 面包屑导航 -->
<nav aria-label="breadcrumb" class="mb-3 animate-fade-in">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin"><i class="bi bi-house-door me-1"></i>首页</a></li>
        <li class="breadcrumb-item active" aria-current="page">回收站</li>
    </ol>
</nav>

<!-- 页面标题区 -->
<div class="page-header animate-fade-in">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="bi bi-trash3 text-danger me-2"></i>回收站
            </h1>
            <p class="page-subtitle">管理已删除的内容，可恢复或彻底删除</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" onclick="loadTrash()">
                <i class="bi bi-arrow-clockwise me-1"></i>刷新
            </button>
            {% if items %}
            <button type="button" class="btn btn-outline-warning" onclick="emptyTrash()">
                <i class="bi bi-trash3 me-1"></i>清空回收站
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4 animate-fade-in">
    <div class="col-md-2">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.total }}</h3>
                <small>总项目</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.posts }}</h3>
                <small>文章</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white h-100">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.products }}</h3>
                <small>产品</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white h-100">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.galleries }}</h3>
                <small>相册</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.columns }}</h3>
                <small>栏目</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-dark text-white h-100">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.pages }}</h3>
                <small>页面</small>
            </div>
        </div>
    </div>
</div>

<!-- 筛选栏 -->
<div class="card mb-4 animate-fade-in">
    <div class="card-body">
        <div class="d-flex gap-2 align-items-center">
            <span class="text-muted">筛选：</span>
            <a href="/admin/trash" class="btn btn-sm {% if not request.query_params.get('type') %}btn-primary{% else btn-outline-secondary{% endif %}">
                全部
            </a>
            <a href="/admin/trash?type=post" class="btn btn-sm {% if request.query_params.get('type') == 'post' %}btn-primary{% else btn-outline-secondary{% endif %}">
                <i class="bi bi-file-earmark-text"></i> 文章
            </a>
            <a href="/admin/trash?type=product" class="btn btn-sm {% if request.query_params.get('type') == 'product' %}btn-primary{% else btn-outline-secondary{% endif %}">
                <i class="bi bi-box-seam"></i> 产品
            </a>
            <a href="/admin/trash?type=gallery" class="btn btn-sm {% if request.query_params.get('type') == 'gallery' %}btn-primary{% else btn-outline-secondary{% endif %}">
                <i class="bi bi-images"></i> 相册
            </a>
            <a href="/admin/trash?type=column" class="btn btn-sm {% if request.query_params.get('type') == 'column' %}btn-primary{% else btn-outline-secondary{% endif %}">
                <i class="bi bi-folder"></i> 栏目
            </a>
            <a href="/admin/trash?type=page" class="btn btn-sm {% if request.query_params.get('type') == 'page' %}btn-primary{% else btn-outline-secondary{% endif %}">
                <i class="bi bi-file-text"></i> 页面
            </a>
        </div>
    </div>
</div>

<!-- 回收站列表 -->
<div class="card animate-fade-in">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="bi bi-list-check text-primary me-2"></i>
            {% if items %}已删除项目 ({{ items|length }}){% else %}回收站为空{% endif %}
        </h5>
    </div>
    <div class="card-body p-0">
        {% if items %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px;">类型</th>
                        <th>标题</th>
                        <th>删除时间</th>
                        <th>删除原因</th>
                        <th class="text-end">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>
                            {% if item.content_type == 'post' %}
                            <span class="badge bg-primary">文章</span>
                            {% elif item.content_type == 'product' %}
                            <span class="badge bg-success">产品</span>
                            {% elif item.content_type == 'gallery' %}
                            <span class="badge bg-info">相册</span>
                            {% elif item.content_type == 'column' %}
                            <span class="badge bg-warning text-dark">栏目</span>
                            {% elif item.content_type == 'page' %}
                            <span class="badge bg-dark">页面</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ item.title }}</strong>
                            <br>
                            <small class="text-muted">ID: {{ item.content_id }}</small>
                        </td>
                        <td>{{ item.deleted_at }}</td>
                        <td>
                            {% if item.reason %}
                            <span class="text-muted">{{ item.reason }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="restoreItem({{ item.id }})">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>恢复
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteItem({{ item.id }})">
                                <i class="bi bi-trash3 me-1"></i>彻底删除
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-trash3 fs-1 d-block mb-3 text-muted"></i>
            <p class="text-muted mb-2">回收站是空的</p>
            <p class="text-muted small">删除的内容会显示在这里，最多保留30天</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 提示信息 -->
<div class="card mt-4 animate-fade-in">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-info-circle text-primary me-2"></i>使用说明
        </h5>
    </div>
    <div class="card-body">
        <ul class="mb-0">
            <li><strong>恢复</strong>：将内容恢复到原始状态</li>
            <li><strong>彻底删除</strong>：永久删除内容，无法恢复</li>
            <li><strong>清空回收站</strong>：删除所有项目，请谨慎操作</li>
            <li>回收站中的内容<strong>不会</strong>在前台显示</li>
            <li>系统自动清理<strong>30天前</strong>的回收站项目</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 恢复项目
async function restoreItem(trashId) {
    if (!confirm('确定要恢复此项目吗？')) return;

    try {
        const result = await fetch('/admin/api/trash/restore', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({trash_id: trashId})
        });
        const data = await result.json();
        if (data.success) {
            showToast('success', '恢复成功', '项目已恢复');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', '恢复失败', data.detail || '未知错误');
        }
    } catch (error) {
        showToast('error', '恢复失败', error.message);
    }
}

// 彻底删除项目
async function deleteItem(trashId) {
    if (!confirm('确定要彻底删除此项目吗？此操作不可恢复！')) return;

    try {
        const result = await fetch(`/admin/api/trash/${trashId}`, {
            method: 'DELETE'
        });
        const data = await result.json();
        if (data.success) {
            showToast('success', '已删除', '项目已彻底删除');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', '删除失败', data.detail || '未知错误');
        }
    } catch (error) {
        showToast('error', '删除失败', error.message);
    }
}

// 清空回收站
async function emptyTrash() {
    if (!confirm('确定要清空回收站吗？此操作将删除所有项目，不可恢复！')) return;

    try {
        const result = await fetch('/admin/api/trash/empty', {
            method: 'DELETE'
        });
        const data = await result.json();
        if (data.success) {
            showToast('success', '已清空', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', '清空失败', data.detail || '未知错误');
        }
    } catch (error) {
        showToast('error', '清空失败', error.message);
    }
}

// 刷新列表
function loadTrash() {
    location.reload();
}
</script>
{% endblock %}
