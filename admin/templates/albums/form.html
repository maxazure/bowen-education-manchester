{% extends "base.html" %}

{% block title %}{{ '编辑' if album else '新建' }}相册 - 博文教育管理后台{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ '编辑' if album else '新建' }}相册</h2>
        </div>
        <div>
            <a href="/admin/albums" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>
    </div>

    <form method="post" action="/admin/albums{% if album %}/{{ album.id }}{% endif %}" id="albumForm">
        {% if album %}
        <input type="hidden" name="_method" value="PUT">
        {% endif %}

        <div class="row">
            <div class="col-md-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">基本信息</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">相册标题 *</label>
                            <input type="text" class="form-control" name="title" required
                                   value="{{ album.title if album else '' }}">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">URL Slug</label>
                            <input type="text" class="form-control" name="slug"
                                   value="{{ album.slug if album else '' }}"
                                   placeholder="留空自动生成">
                            <small class="form-text text-muted">用于 URL 地址，如：2024-spring-sports-day</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">相册描述</label>
                            <textarea class="form-control" name="description" rows="4">{{ album.description if album else '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">SEO 优化</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">SEO 标题</label>
                            <input type="text" class="form-control" name="seo_title"
                                   value="{{ album.seo_title if album else '' }}">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">SEO 描述</label>
                            <textarea class="form-control" name="seo_description" rows="3">{{ album.seo_description if album else '' }}</textarea>
                        </div>

                        <div class="mb-0">
                            <label class="form-label">SEO 关键词</label>
                            <input type="text" class="form-control" name="seo_keywords"
                                   value="{{ album.seo_keywords if album else '' }}"
                                   placeholder="多个关键词用逗号分隔">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">发布设置</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">状态</label>
                            <select class="form-select" name="status">
                                <option value="draft" {% if not album or album.status == 'draft' %}selected{% endif %}>草稿</option>
                                <option value="published" {% if album and album.status == 'published' %}selected{% endif %}>已发布</option>
                            </select>
                        </div>

                        <div class="mb-0">
                            <label class="form-label">分类</label>
                            <select class="form-select" name="category_id">
                                <option value="">无分类</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}"
                                        {% if album and album.category_id == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                {% if album %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">相册信息</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>照片数量：</strong>{{ album.photo_count }}</p>
                        <p class="mb-1"><strong>浏览次数：</strong>{{ album.view_count }}</p>
                        <p class="mb-0"><strong>创建时间：</strong>{{ album.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </div>
                {% endif %}

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> {{ '更新' if album else '创建' }}相册
                    </button>
                    {% if album %}
                    <a href="/admin/albums/{{ album.id }}/photos" class="btn btn-outline-primary">
                        <i class="bi bi-images"></i> 管理照片
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.getElementById('albumForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const action = this.action;
    const method = formData.get('_method') || 'POST';

    // 删除 _method 字段
    formData.delete('_method');

    const options = {
        method: method,
        body: formData
    };

    fetch(action, options)
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.success) {
                alert(data.message || '保存成功');
                if (data.album && data.album.id) {
                    window.location.href = `/admin/albums/${data.album.id}/edit`;
                } else {
                    window.location.href = '/admin/albums';
                }
            } else if (data && !data.success) {
                alert('保存失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('保存失败，请重试');
        });
});
</script>
{% endblock %}
