{% extends "base.html" %}

{% block title %}{% if post %}编辑文章{% else %}新建文章{% endif %} - 博文教育管理后台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<style>
/* Tab 导航样式优化 */
.language-tabs {
    margin-bottom: 2rem;
    border-bottom: 2px solid #dee2e6;
}

.language-tabs .nav-link {
    font-weight: 500;
    color: #6c757d;
    padding: 1rem 1.5rem;
    border: none;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
}

.language-tabs .nav-link:hover {
    color: #0d6efd;
    background-color: #f8f9fa;
}

.language-tabs .nav-link.active {
    color: #0d6efd;
    background-color: transparent;
    border-bottom-color: #0d6efd;
}

.language-tabs .nav-link i {
    margin-right: 0.5rem;
}

/* Tab 内容容器 */
.tab-content {
    padding-top: 1.5rem;
}

/* 确保两个 EasyMDE 编辑器独立渲染 */
.CodeMirror {
    min-height: 400px;
    max-height: 600px;
}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <!-- 页面头部 -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title mb-1">
                <i class="bi bi-{% if post %}pencil-square{% else %}plus-circle{% endif %} me-2"></i>
                {% if post %}编辑文章{% else %}新建文章{% endif %}
            </h1>
            <p class="page-subtitle mb-0">
                {% if post %}
                更新文章信息和内容（支持中英双语编辑）
                {% else %}
                创建一篇新的文章内容（支持中英双语编辑）
                {% endif %}
            </p>
        </div>
        <div>
            <a href="/admin/posts" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </div>

    <!-- 表单内容 -->
    <form method="POST" action="{{ action }}" id="postForm" class="needs-validation" novalidate>
        <div class="form-layout">
            <!-- 左侧主要内容 -->
            <div class="form-main">
                <!-- 语言切换 Tab -->
                <ul class="nav nav-tabs language-tabs" id="languageTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="zh-tab" data-bs-toggle="tab" data-bs-target="#zh-content" type="button" role="tab" aria-controls="zh-content" aria-selected="true">
                            <i class="bi bi-translate"></i>中文内容
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="en-tab" data-bs-toggle="tab" data-bs-target="#en-content" type="button" role="tab" aria-controls="en-content" aria-selected="false">
                            <i class="bi bi-globe"></i>English Content
                        </button>
                    </li>
                </ul>

                <!-- Tab 内容 -->
                <div class="tab-content" id="languageTabContent">
                    <!-- 中文内容 Tab -->
                    <div class="tab-pane fade show active" id="zh-content" role="tabpanel" aria-labelledby="zh-tab">
                        <!-- 基本信息卡片 (中文) -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-info-circle me-2"></i>基本信息 (中文)
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- 标题 -->
                                <div class="mb-3">
                                    <label for="title" class="form-label">
                                        文章标题 <span class="text-danger">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="title"
                                        name="title"
                                        value="{{ post.title if post else '' }}"
                                        required
                                        placeholder="请输入中文标题">
                                    <div class="invalid-feedback">
                                        请输入文章标题
                                    </div>
                                </div>

                                <!-- Slug (共享字段，只在中文 Tab 显示) -->
                                <div class="mb-3">
                                    <label for="slug" class="form-label">
                                        URL Slug
                                    </label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="slug"
                                        name="slug"
                                        value="{{ post.slug if post else '' }}"
                                        placeholder="留空自动生成">
                                    <div class="help-text">
                                        <i class="bi bi-info-circle"></i>
                                        <span>URL 友好的标识符，留空将根据标题自动生成</span>
                                    </div>
                                </div>

                                <!-- 摘要 -->
                                <div class="mb-0">
                                    <label for="summary" class="form-label">
                                        文章摘要
                                    </label>
                                    <textarea
                                        class="form-control"
                                        id="summary"
                                        name="summary"
                                        rows="3"
                                        placeholder="请输入中文摘要">{{ post.summary if post else '' }}</textarea>
                                    <div class="help-text">
                                        <i class="bi bi-info-circle"></i>
                                        <span>简短描述文章内容，用于列表展示</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 文章内容卡片 (中文) -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-file-text me-2"></i>文章内容 (中文)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-0">
                                    <label for="content_markdown" class="form-label">
                                        内容 (Markdown) <span class="text-danger">*</span>
                                    </label>
                                    <textarea
                                        id="content_markdown"
                                        name="content_markdown"
                                        required>{{ post.content_markdown if post else '' }}</textarea>
                                    <div class="invalid-feedback">
                                        请输入文章内容
                                    </div>
                                    <div class="help-text">
                                        <i class="bi bi-markdown"></i>
                                        <span>支持 Markdown 格式编辑，实时预览内容效果</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SEO 设置卡片 (中文) -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-search me-2"></i>SEO 设置 (中文)
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- SEO 标题 -->
                                <div class="mb-3">
                                    <label for="seo_title" class="form-label">
                                        SEO 标题
                                    </label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="seo_title"
                                        name="seo_title"
                                        value="{{ post.seo_title if post else '' }}"
                                        placeholder="留空使用文章标题">
                                </div>

                                <!-- SEO 描述 -->
                                <div class="mb-0">
                                    <label for="seo_description" class="form-label">
                                        SEO 描述
                                    </label>
                                    <textarea
                                        class="form-control"
                                        id="seo_description"
                                        name="seo_description"
                                        rows="3"
                                        placeholder="用于搜索引擎显示的描述">{{ post.seo_description if post else '' }}</textarea>
                                    <div class="help-text">
                                        <i class="bi bi-info-circle"></i>
                                        <span>建议长度 120-160 字符，用于搜索引擎结果展示</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 英文内容 Tab -->
                    <div class="tab-pane fade" id="en-content" role="tabpanel" aria-labelledby="en-tab">
                        <!-- 基本信息卡片 (英文) -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-info-circle me-2"></i>Basic Information (English)
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- 英文标题 -->
                                <div class="mb-3">
                                    <label for="title_en" class="form-label">
                                        Article Title (English)
                                    </label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="title_en"
                                        name="title_en"
                                        value="{{ post.title_en if post else '' }}"
                                        placeholder="Enter English title">
                                    <div class="help-text">
                                        <i class="bi bi-info-circle"></i>
                                        <span>Optional - If not provided, Chinese title will be used</span>
                                    </div>
                                </div>

                                <!-- 英文摘要 -->
                                <div class="mb-0">
                                    <label for="summary_en" class="form-label">
                                        Article Summary (English)
                                    </label>
                                    <textarea
                                        class="form-control"
                                        id="summary_en"
                                        name="summary_en"
                                        rows="3"
                                        placeholder="Enter English summary">{{ post.summary_en if post else '' }}</textarea>
                                    <div class="help-text">
                                        <i class="bi bi-info-circle"></i>
                                        <span>Brief description for article listing</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 文章内容卡片 (英文) -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-file-text me-2"></i>Article Content (English)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-0">
                                    <label for="content_markdown_en" class="form-label">
                                        Content (Markdown)
                                    </label>
                                    <textarea
                                        id="content_markdown_en"
                                        name="content_markdown_en">{{ post.content_markdown_en if post else '' }}</textarea>
                                    <div class="help-text">
                                        <i class="bi bi-markdown"></i>
                                        <span>Supports Markdown format with live preview</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SEO 设置卡片 (英文) -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-search me-2"></i>SEO Settings (English)
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- SEO 标题 -->
                                <div class="mb-3">
                                    <label for="seo_title_en" class="form-label">
                                        SEO Title
                                    </label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="seo_title_en"
                                        name="seo_title_en"
                                        value="{{ post.seo_title_en if post else '' }}"
                                        placeholder="Leave empty to use article title">
                                </div>

                                <!-- SEO 描述 -->
                                <div class="mb-0">
                                    <label for="seo_description_en" class="form-label">
                                        SEO Description
                                    </label>
                                    <textarea
                                        class="form-control"
                                        id="seo_description_en"
                                        name="seo_description_en"
                                        rows="3"
                                        placeholder="Description for search engines">{{ post.seo_description_en if post else '' }}</textarea>
                                    <div class="help-text">
                                        <i class="bi bi-info-circle"></i>
                                        <span>Recommended length: 120-160 characters for search results</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 表单操作按钮 -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>
                        {% if post %}更新文章{% else %}创建文章{% endif %}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/admin/posts'">
                        <i class="bi bi-x-circle me-2"></i>
                        取消
                    </button>
                </div>
            </div>

            <!-- 右侧侧边栏 (发布设置和分类 - 共享设置) -->
            <div class="form-sidebar">
                <!-- 发布设置 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-send me-2"></i>发布设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">
                                <i class="bi bi-journal-text"></i>
                                <span>所属栏目</span>
                            </div>
                            <select class="form-select" id="column_id" name="column_id" required>
                                <option value="">-- 选择栏目 --</option>
                                {% for column in columns %}
                                <option value="{{ column.id }}" {% if post and column.id == post.column_id %}selected{% endif %}>
                                    {{ column.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                请选择文章所属栏目
                            </div>
                        </div>

                        <div class="sidebar-section">
                            <div class="sidebar-section-title">
                                <i class="bi bi-toggle-on"></i>
                                <span>状态</span>
                            </div>
                            <select class="form-select" name="status">
                                <option value="draft" {% if not post or post.status == 'draft' %}selected{% endif %}>
                                    <i class="bi bi-file-earmark"></i> 草稿
                                </option>
                                <option value="published" {% if post and post.status == 'published' %}selected{% endif %}>
                                    <i class="bi bi-check-circle"></i> 已发布
                                </option>
                                <option value="offline" {% if post and post.status == 'offline' %}selected{% endif %}>
                                    <i class="bi bi-x-circle"></i> 已下线
                                </option>
                            </select>
                        </div>

                        <div class="sidebar-section">
                            <div class="sidebar-section-title">
                                <i class="bi bi-star"></i>
                                <span>特殊标记</span>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    id="is_recommended"
                                    name="is_recommended"
                                    value="1"
                                    {% if post and post.is_recommended %}checked{% endif %}>
                                <label class="form-check-label" for="is_recommended">
                                    <i class="bi bi-heart text-danger me-1"></i>推荐文章
                                </label>
                            </div>

                            <div class="form-check form-switch mb-0">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    id="is_pinned"
                                    name="is_pinned"
                                    value="1"
                                    {% if post and post.is_pinned %}checked{% endif %}>
                                <label class="form-check-label" for="is_pinned">
                                    <i class="bi bi-pin-angle text-primary me-1"></i>置顶文章
                                </label>
                            </div>
                        </div>

                        <div class="sidebar-section mb-0">
                            <div class="sidebar-section-title">
                                <i class="bi bi-image"></i>
                                <span>封面图片</span>
                            </div>
                            <input
                                type="number"
                                class="form-control"
                                id="cover_media_id"
                                name="cover_media_id"
                                value="{{ post.cover_media_id if post else '' }}"
                                placeholder="输入媒体 ID">
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i>
                                <span>请输入媒体库中图片的 ID</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 分类设置 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-folder me-2"></i>文章分类
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if categories %}
                        <div class="category-checkboxes">
                            {% for category in categories %}
                            <div class="form-check">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    name="category_checkbox"
                                    value="{{ category.id }}"
                                    id="category_{{ category.id }}"
                                    {% if post and category in post.categories %}checked{% endif %}>
                                <label class="form-check-label" for="category_{{ category.id }}">
                                    {{ category.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="category_ids" id="category_ids" value="{% if post %}{{ post.categories|map(attribute='id')|join(',') }}{% endif %}">
                        <div class="help-text mt-2">
                            <i class="bi bi-info-circle"></i>
                            <span>可以选择多个分类</span>
                        </div>
                        {% else %}
                        <div class="empty-categories">
                            <i class="bi bi-folder-x d-block"></i>
                            <p class="mb-0">暂无分类</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
(function() {
    'use strict';

    // 初始化中文 Markdown 编辑器
    const easyMDE_zh = new EasyMDE({
        element: document.getElementById('content_markdown'),
        spellChecker: false,
        autosave: {
            enabled: true,
            uniqueId: 'post-content-zh-' + ({{ post.id if post else 0 }}),
            delay: 5000,
        },
        placeholder: '请输入中文文章内容，支持 Markdown 格式...',
        minHeight: '400px',
        maxHeight: '600px',
        toolbar: [
            'bold', 'italic', 'heading', '|',
            'quote', 'unordered-list', 'ordered-list', '|',
            'link', 'image', '|',
            'preview', 'side-by-side', 'fullscreen', '|',
            'guide'
        ],
        status: ['autosave', 'lines', 'words', 'cursor'],
        renderingConfig: {
            codeSyntaxHighlighting: true,
        }
    });

    // 初始化英文 Markdown 编辑器
    const easyMDE_en = new EasyMDE({
        element: document.getElementById('content_markdown_en'),
        spellChecker: false,
        autosave: {
            enabled: true,
            uniqueId: 'post-content-en-' + ({{ post.id if post else 0 }}),
            delay: 5000,
        },
        placeholder: 'Enter English article content, supports Markdown format...',
        minHeight: '400px',
        maxHeight: '600px',
        toolbar: [
            'bold', 'italic', 'heading', '|',
            'quote', 'unordered-list', 'ordered-list', '|',
            'link', 'image', '|',
            'preview', 'side-by-side', 'fullscreen', '|',
            'guide'
        ],
        status: ['autosave', 'lines', 'words', 'cursor'],
        renderingConfig: {
            codeSyntaxHighlighting: true,
        }
    });

    // 分类复选框处理
    const categoryCheckboxes = document.querySelectorAll('input[name="category_checkbox"]');
    const categoryIdsInput = document.getElementById('category_ids');

    function updateCategoryIds() {
        const selectedIds = Array.from(categoryCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        categoryIdsInput.value = selectedIds.join(',');
    }

    categoryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCategoryIds);
    });

    // Bootstrap 表单验证
    const form = document.getElementById('postForm');

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        event.stopPropagation();

        // 验证表单
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        // 提交表单
        submitForm();
    });

    // AJAX 提交表单
    function submitForm() {
        const formData = new FormData(form);

        // 处理复选框值（确保布尔值正确传递）
        formData.set('is_recommended', document.getElementById('is_recommended').checked);
        formData.set('is_pinned', document.getElementById('is_pinned').checked);

        // 获取中文和英文 Markdown 内容
        formData.set('content_markdown', easyMDE_zh.value());
        formData.set('content_markdown_en', easyMDE_en.value());

        // 显示加载状态
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message, '成功');

                // 延迟跳转到列表页
                setTimeout(() => {
                    window.location.href = '/admin/posts';
                }, 1500);
            } else {
                showToast('danger', data.message, '错误');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('danger', '提交失败: ' + error.message, '错误');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }

    // 自动生成 Slug（可选功能）
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');

    titleInput.addEventListener('blur', function() {
        if (!slugInput.value && titleInput.value) {
            // 简单的拼音转换（实际使用可能需要更复杂的处理）
            const slug = titleInput.value
                .toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
            slugInput.value = slug;
        }
    });

    // 防止意外离开页面
    let formChanged = false;

    form.addEventListener('change', function() {
        formChanged = true;
    });

    easyMDE_zh.codemirror.on('change', function() {
        formChanged = true;
    });

    easyMDE_en.codemirror.on('change', function() {
        formChanged = true;
    });

    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    // 表单提交后清除警告
    form.addEventListener('submit', function() {
        formChanged = false;
    });

})();
</script>
{% endblock %}
