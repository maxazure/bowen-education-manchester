{% extends "base.html" %}

{% block title %}数据报表 - 博文教育管理后台{% endblock %}

{% block content %}
<!-- 面包屑导航 -->
<nav aria-label="breadcrumb" class="mb-3 animate-fade-in">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin"><i class="bi bi-house-door me-1"></i>首页</a></li>
        <li class="breadcrumb-item active" aria-current="page">数据报表</li>
    </ol>
</nav>

<!-- 页面标题区 -->
<div class="page-header animate-fade-in">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="bi bi-bar-chart-line text-primary me-2"></i>数据报表
            </h1>
            <p class="page-subtitle">内容数据统计与分析</p>
        </div>
        <div class="d-flex gap-2">
            <select class="form-select" id="dateRange" style="width: 150px;" onchange="changeDateRange()">
                <option value="7">最近7天</option>
                <option value="14">最近14天</option>
                <option value="30" selected>最近30天</option>
                <option value="90">最近90天</option>
                <option value="365">最近1年</option>
            </select>
            <button class="btn btn-outline-secondary" onclick="exportReport()">
                <i class="bi bi-download me-1"></i>导出报表
            </button>
        </div>
    </div>
</div>

<!-- 核心指标卡片 -->
<div class="row mb-4 animate-fade-in">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="card-text small mb-1">内容总量</p>
                        <h2 class="mb-0" id="totalContent">-</h2>
                    </div>
                    <i class="bi bi-file-earmark-text fs-1 opacity-50"></i>
                </div>
                <div class="mt-2 small">
                    <span id="contentChange">加载中...</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="card-text small mb-1">发布量</p>
                        <h2 class="mb-0" id="publishedContent">-</h2>
                    </div>
                    <i class="bi bi-check-circle fs-1 opacity-50"></i>
                </div>
                <div class="mt-2 small">
                    <span id="publishedChange">加载中...</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="card-text small mb-1">新增内容</p>
                        <h2 class="mb-0" id="newContent">-</h2>
                    </div>
                    <i class="bi bi-plus-circle fs-1 opacity-50"></i>
                </div>
                <div class="mt-2 small">
                    <span>较上期</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="card-text small mb-1">待审核</p>
                        <h2 class="mb-0" id="pendingApproval">-</h2>
                    </div>
                    <i class="bi bi-clock fs-1 opacity-50"></i>
                </div>
                <div class="mt-2 small">
                    <span>需要处理</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row mb-4 animate-fade-in">
    <!-- 内容增长趋势 -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up text-primary me-2"></i>内容增长趋势
                </h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- 内容分布 -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart text-success me-2"></i>内容类型分布
                </h5>
            </div>
            <div class="card-body">
                <div style="height: 200px;">
                    <canvas id="typeChart"></canvas>
                </div>
                <div class="mt-3" id="typeLegend"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 animate-fade-in">
    <!-- 栏目内容统计 -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-folder text-info me-2"></i>栏目内容统计
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="columnStatsTable">
                        <thead class="table-light">
                            <tr>
                                <th>栏目</th>
                                <th class="text-center">文章</th>
                                <th class="text-center">产品</th>
                                <th class="text-center">相册</th>
                                <th class="text-center">总计</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center py-4">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- 内容状态分布 -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart text-warning me-2"></i>内容状态分布
                </h5>
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细统计表格 -->
<div class="card animate-fade-in">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-table text-secondary me-2"></i>详细数据统计
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="detailStatsTable">
                <thead class="table-light">
                    <tr>
                        <th>统计项目</th>
                        <th class="text-center">数量</th>
                        <th class="text-center">占比</th>
                        <th class="text-center">较上期</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="text-center py-4">加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 说明 -->
<div class="card mt-4 animate-fade-in">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-info-circle text-primary me-2"></i>数据说明
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>统计周期</h6>
                <ul class="small mb-0">
                    <li>日报：当日数据</li>
                    <li>周报：最近7天数据</li>
                    <li>月报：最近30天数据</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>数据更新</h6>
                <ul class="small mb-0">
                    <li>数据每5分钟自动刷新</li>
                    <li>点击"刷新"按钮可立即更新</li>
                    <li>导出报表将下载当前时间点的数据</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局图表实例
let trendChart, typeChart, statusChart;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadReportData();
});

// 初始化图表
function initCharts() {
    // 内容趋势图
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '文章',
                    data: [],
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: '产品',
                    data: [],
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: '相册',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // 类型分布图
    const typeCtx = document.getElementById('typeChart');
    if (typeCtx) {
        typeChart = new Chart(typeCtx, {
            type: 'doughnut',
            data: {
                labels: ['文章', '产品', '相册', '栏目', '单页'],
                datasets: [{
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: ['#6366f1', '#22c55e', '#3b82f6', '#f59e0b', '#ec4899']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // 状态分布图
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        statusChart = new Chart(statusCtx, {
            type: 'bar',
            data: {
                labels: ['已发布', '草稿', '已下线', '待审核'],
                datasets: [{
                    label: '数量',
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#22c55e', '#6b7280', '#f59e0b', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
}

// 加载报表数据
async function loadReportData() {
    const days = document.getElementById('dateRange').value;

    try {
        // 并行加载数据
        const [overviewRes, trendRes, columnRes] = await Promise.all([
            fetch(`/admin/api/stats?days=${days}`),
            fetch(`/admin/api/stats/trend?days=${days}`),
            fetch('/admin/api/stats/columns')
        ]);

        const overview = await overviewRes.json();
        const trend = await trendRes.json();
        const columns = await columnRes.json();

        // 更新核心指标
        updateOverviewStats(overview.data);

        // 更新趋势图
        updateTrendChart(trend.data);

        // 更新类型分布图
        updateTypeChart(overview.data);

        // 更新状态分布图
        updateStatusChart(overview.data);

        // 更新栏目统计
        updateColumnStats(columns.data);

        // 更新详细统计
        updateDetailStats(overview.data);

    } catch (error) {
        console.error('加载报表数据失败:', error);
        showToast('error', '加载失败', '报表数据加载失败');
    }
}

// 更新核心指标
function updateOverviewStats(data) {
    document.getElementById('totalContent').textContent = formatNumber(data.total || 0);
    document.getElementById('publishedContent').textContent = formatNumber(data.publishedPosts || 0);
    document.getElementById('newContent').textContent = formatNumber(data.monthlyPosts || 0);
    document.getElementById('pendingApproval').textContent = data.pendingApproval || 0;

    // 计算变化
    const total = data.total || 0;
    const published = data.publishedPosts || 0;
    const publishedRate = total > 0 ? ((published / total) * 100).toFixed(1) : 0;

    document.getElementById('contentChange').innerHTML = `
        <i class="bi bi-folder2"></i> 全部 ${formatNumber(total)} 篇
    `;
    document.getElementById('publishedChange').innerHTML = `
        <i class="bi bi-check-circle"></i> 发布率 ${publishedRate}%
    `;
}

// 更新趋势图
function updateTrendChart(data) {
    if (!trendChart) return;

    trendChart.data.labels = data.labels || [];
    trendChart.data.datasets[0].data = data.posts || [];
    trendChart.data.datasets[1].data = data.products || [];
    trendChart.data.datasets[2].data = data.galleries || [];
    trendChart.update();
}

// 更新类型分布图
function updateTypeChart(data) {
    if (!typeChart) return;

    const counts = [
        data.posts || 0,
        data.products || 0,
        data.galleries || 0,
        data.columns || 0,
        data.pages || 0
    ];

    typeChart.data.datasets[0].data = counts;
    typeChart.update();

    // 更新图例
    const labels = ['文章', '产品', '相册', '栏目', '单页'];
    const colors = ['#6366f1', '#22c55e', '#3b82f6', '#f59e0b', '#ec4899'];
    let legendHtml = '<div class="row mt-3">';

    counts.forEach((count, i) => {
        if (count > 0) {
            const rate = counts.reduce((a, b) => a + b, 0) > 0
                ? ((count / counts.reduce((a, b) => a + b, 0)) * 100).toFixed(1)
                : 0;
            legendHtml += `
                <div class="col-6 mb-2">
                    <i class="bi bi-square-fill" style="color: ${colors[i]}"></i>
                    ${labels[i]}: ${formatNumber(count)} (${rate}%)
                </div>
            `;
        }
    });

    legendHtml += '</div>';
    document.getElementById('typeLegend').innerHTML = legendHtml;
}

// 更新状态分布图
function updateStatusChart(data) {
    if (!statusChart) return;

    statusChart.data.datasets[0].data = [
        data.publishedPosts || 0,
        data.draftPosts || 0,
        data.offlinePosts || 0,
        data.pendingApproval || 0
    ];
    statusChart.update();
}

// 更新栏目统计
function updateColumnStats(data) {
    const tbody = document.querySelector('#columnStatsTable tbody');
    if (!tbody) return;

    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">暂无数据</td></tr>';
        return;
    }

    let html = '';
    data.forEach(col => {
        const total = (col.posts || 0) + (col.products || 0) + (col.galleries || 0);
        html += `
            <tr>
                <td>
                    <strong>${col.name}</strong>
                    ${col.name_en ? `<br><small class="text-muted">${col.name_en}</small>` : ''}
                </td>
                <td class="text-center"><span class="badge bg-primary">${col.posts || 0}</span></td>
                <td class="text-center"><span class="badge bg-success">${col.products || 0}</span></td>
                <td class="text-center"><span class="badge bg-info">${col.galleries || 0}</span></td>
                <td class="text-center"><strong>${total}</strong></td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

// 更新详细统计
function updateDetailStats(data) {
    const tbody = document.querySelector('#detailStatsTable tbody');
    if (!tbody) return;

    const total = data.total || 1;
    const items = [
        { name: '文章总数', value: data.posts || 0 },
        { name: '产品总数', value: data.products || 0 },
        { name: '相册总数', value: data.galleries || 0 },
        { name: '栏目总数', value: data.columns || 0 },
        { name: '单页总数', value: data.pages || 0 },
        { name: '已发布文章', value: data.publishedPosts || 0, rate: (data.publishedPosts || 0) / (data.posts || 1) * 100 },
        { name: '草稿文章', value: data.draftPosts || 0, rate: (data.draftPosts || 0) / (data.posts || 1) * 100 },
        { name: '推荐文章', value: data.recommendedPosts || 0 },
        { name: '置顶文章', value: data.pinnedPosts || 0 },
    ];

    let html = '';
    items.forEach(item => {
        const rate = item.rate !== undefined
            ? item.rate.toFixed(1) + '%'
            : (total > 0 ? ((item.value / total) * 100).toFixed(1) + '%' : '0%');

        html += `
            <tr>
                <td>${item.name}</td>
                <td class="text-center"><strong>${formatNumber(item.value)}</strong></td>
                <td class="text-center">${rate}</td>
                <td class="text-center text-success">
                    <i class="bi bi-arrow-up"></i> -
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

// 切换日期范围
function changeDateRange() {
    loadReportData();
}

// 导出报表
function exportReport() {
    const days = document.getElementById('dateRange').value;
    window.open(`/admin/reports/export?days=${days}`, '_blank');
    showToast('success', '正在导出', '报表即将下载');
}

// 格式化数字
function formatNumber(num) {
    if (num >= 10000) {
        return (num / 10000).toFixed(1) + '万';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'k';
    }
    return num.toString();
}
</script>
{% endblock %}
