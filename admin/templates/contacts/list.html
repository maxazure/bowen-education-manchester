{% extends "base.html" %}

{% block title %}留言管理 - 博文教育管理后台{% endblock %}

{% block extra_css %}
<style>
    /* 统计卡片自定义样式 */
    .stat-badge {
        font-size: 2rem;
        font-weight: 700;
        color: var(--bs-dark);
    }

    /* 留言预览文本截断 */
    .message-preview {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: block;
    }

    /* 批量操作栏 */
    .batch-actions-bar {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        display: none;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 筛选表单样式 */
    .filters-card {
        background-color: var(--bg-light);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }

    /* 表格操作按钮组 */
    .action-buttons .btn {
        padding: 4px 8px;
        font-size: 13px;
    }

    /* 详情模态框内容样式 */
    .detail-item {
        padding: 12px;
        background-color: var(--bg-light);
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .detail-label {
        font-weight: 600;
        color: var(--bs-secondary-text);
        font-size: 13px;
        margin-bottom: 4px;
    }

    .detail-value {
        color: var(--bs-body-color);
        font-size: 14px;
        word-wrap: break-word;
    }

    /* 响应式表格适配 */
    @media (max-width: 991.98px) {
        .message-preview {
            max-width: 200px;
        }
    }

    @media (max-width: 767.98px) {
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .action-buttons .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">留言管理</h1>
        <p class="page-subtitle mb-0">管理用户提交的联系留言和咨询信息</p>
    </div>
    <div>
        <button class="btn btn-success" onclick="exportCSV()">
            <i class="bi bi-download me-1"></i>导出 CSV
        </button>
    </div>
</div>

<!-- 统计信息卡片 -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stat-card bg-warning-light">
            <div class="card-body d-flex align-items-center">
                <div class="stat-icon bg-warning text-white me-3">
                    <i class="bi bi-envelope-exclamation"></i>
                </div>
                <div>
                    <div class="stat-label">未读留言</div>
                    <div class="stat-badge text-warning">{{ unread_count }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card bg-success-light">
            <div class="card-body d-flex align-items-center">
                <div class="stat-icon bg-success text-white me-3">
                    <i class="bi bi-envelope-check"></i>
                </div>
                <div>
                    <div class="stat-label">已处理</div>
                    <div class="stat-badge text-success">{{ handled_count }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card bg-info-light">
            <div class="card-body d-flex align-items-center">
                <div class="stat-icon bg-info text-white me-3">
                    <i class="bi bi-envelope"></i>
                </div>
                <div>
                    <div class="stat-label">总计</div>
                    <div class="stat-badge text-info">{{ total }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 筛选表单 -->
<div class="filters-card">
    <form method="GET" action="/contacts" class="row g-3">
        <div class="col-md-3">
            <label class="form-label">状态筛选</label>
            <select name="status_filter" class="form-select" onchange="this.form.submit()">
                <option value="">所有状态</option>
                <option value="unread" {% if current_status == 'unread' %}selected{% endif %}>未读</option>
                <option value="handled" {% if current_status == 'handled' %}selected{% endif %}>已处理</option>
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label">关键词搜索</label>
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" name="keyword" class="form-control"
                       value="{{ current_keyword or '' }}"
                       placeholder="搜索姓名、联系方式、留言内容">
            </div>
        </div>

        <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-fill">
                    <i class="bi bi-search me-1"></i>搜索
                </button>
                {% if current_status or current_keyword %}
                <a href="/admin/contacts" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- 批量操作栏 -->
<div class="batch-actions-bar" id="batchActions">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
            <i class="bi bi-check-circle text-warning me-2"></i>
            已选择 <strong id="selectedCount">0</strong> 条留言
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-success" onclick="batchMarkAsHandled()">
                <i class="bi bi-check-all me-1"></i>标记为已处理
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="batchMarkAsUnread()">
                <i class="bi bi-arrow-counterclockwise me-1"></i>标记为未读
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="clearSelection()">
                <i class="bi bi-x-circle me-1"></i>取消选择
            </button>
        </div>
    </div>
</div>

<!-- 留言列表卡片 -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 120px;">姓名</th>
                        <th style="width: 150px;">联系方式</th>
                        <th>留言内容</th>
                        <th style="width: 100px;">状态</th>
                        <th style="width: 150px;">创建时间</th>
                        <th style="width: 200px;" class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% if contacts %}
                    {% for contact in contacts %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input contact-checkbox"
                                   value="{{ contact.id }}" onchange="updateBatchActions()">
                        </td>
                        <td>{{ contact.id }}</td>
                        <td>{{ contact.name }}</td>
                        <td>{{ contact.contact_info }}</td>
                        <td>
                            <span class="message-preview" title="{{ contact.message_text }}">
                                {{ contact.message_text }}
                            </span>
                        </td>
                        <td>
                            {% if contact.status == 'unread' %}
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-envelope-exclamation me-1"></i>未读
                            </span>
                            {% else %}
                            <span class="badge bg-success">
                                <i class="bi bi-envelope-check me-1"></i>已处理
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ contact.created_at.strftime('%Y-%m-%d %H:%M') }}
                            </small>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary"
                                        onclick="viewDetail({{ contact.id }})"
                                        data-bs-toggle="tooltip"
                                        title="查看详情">
                                    <i class="bi bi-eye"></i>
                                </button>
                                {% if contact.status == 'unread' %}
                                <button class="btn btn-sm btn-success"
                                        onclick="markAsHandled({{ contact.id }})"
                                        data-bs-toggle="tooltip"
                                        title="标记已处理">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary"
                                        onclick="markAsUnread({{ contact.id }})"
                                        data-bs-toggle="tooltip"
                                        title="标记未读">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="deleteContact({{ contact.id }})"
                                        data-bs-toggle="tooltip"
                                        title="删除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <h3>暂无留言</h3>
                                <p>当前没有符合条件的留言记录</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 分页 -->
    {% if total_pages > 1 %}
    <div class="card-footer bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">
                <small>第 {{ page }} / {{ total_pages }} 页 (共 {{ total }} 条)</small>
            </div>
            <nav aria-label="留言分页">
                <ul class="pagination mb-0">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}{% if current_status %}&status_filter={{ current_status }}{% endif %}{% if current_keyword %}&keyword={{ current_keyword }}{% endif %}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">
                            <i class="bi bi-chevron-left"></i>
                        </span>
                    </li>
                    {% endif %}

                    <!-- 显示页码 -->
                    {% set start_page = [1, page - 2]|max %}
                    {% set end_page = [total_pages, page + 2]|min %}

                    {% if start_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if current_status %}&status_filter={{ current_status }}{% endif %}{% if current_keyword %}&keyword={{ current_keyword }}{% endif %}">1</a>
                    </li>
                    {% if start_page > 2 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endif %}

                    {% for p in range(start_page, end_page + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="?page={{ p }}{% if current_status %}&status_filter={{ current_status }}{% endif %}{% if current_keyword %}&keyword={{ current_keyword }}{% endif %}">{{ p }}</a>
                    </li>
                    {% endfor %}

                    {% if end_page < total_pages %}
                    {% if end_page < total_pages - 1 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ total_pages }}{% if current_status %}&status_filter={{ current_status }}{% endif %}{% if current_keyword %}&keyword={{ current_keyword }}{% endif %}">{{ total_pages }}</a>
                    </li>
                    {% endif %}

                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}{% if current_status %}&status_filter={{ current_status }}{% endif %}{% if current_keyword %}&keyword={{ current_keyword }}{% endif %}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">
                            <i class="bi bi-chevron-right"></i>
                        </span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- 详情模态框 -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">
                    <i class="bi bi-envelope-open me-2"></i>留言详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- 详情内容将通过 AJAX 加载 -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-3 text-muted">正在加载详情...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>关闭
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/**
 * 留言管理前端交互脚本 - Bootstrap 5 版本
 */

// 查看留言详情
function viewDetail(contactId) {
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();

    // 显示加载状态
    document.getElementById('detailContent').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-3 text-muted">正在加载详情...</p>
        </div>
    `;

    // 获取详情数据
    fetch(`/admin/contacts/${contactId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const contact = data.data;
                const statusText = contact.status === 'unread' ? '未读' : '已处理';
                const statusBadgeClass = contact.status === 'unread' ? 'bg-warning text-dark' : 'bg-success';
                const statusIcon = contact.status === 'unread' ? 'envelope-exclamation' : 'envelope-check';

                let detailHTML = `
                    <div class="detail-item">
                        <div class="detail-label">留言 ID</div>
                        <div class="detail-value">${contact.id}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">姓名</div>
                        <div class="detail-value">${contact.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">联系方式</div>
                        <div class="detail-value">${contact.contact_info}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">留言内容</div>
                        <div class="detail-value" style="white-space: pre-wrap;">${contact.message_text}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">状态</div>
                        <div class="detail-value">
                            <span class="badge ${statusBadgeClass}">
                                <i class="bi bi-${statusIcon} me-1"></i>${statusText}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">来源页面</div>
                        <div class="detail-value">${contact.source_page_url || '未知'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">创建时间</div>
                        <div class="detail-value">
                            <i class="bi bi-clock me-1"></i>${contact.created_at}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">处理时间</div>
                        <div class="detail-value">
                            <i class="bi bi-check-circle me-1"></i>${contact.handled_at || '未处理'}
                        </div>
                    </div>
                `;

                document.getElementById('detailContent').innerHTML = detailHTML;
            } else {
                document.getElementById('detailContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>获取详情失败
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('detailContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>获取详情失败，请稍后重试
                </div>
            `;
        });
}

// 标记为已处理
function markAsHandled(contactId) {
    updateStatus(contactId, 'handled');
}

// 标记为未读
function markAsUnread(contactId) {
    updateStatus(contactId, 'unread');
}

// 更新留言状态
function updateStatus(contactId, status) {
    const statusText = status === 'handled' ? '已处理' : '未读';

    fetch(`/admin/contacts/${contactId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message, '成功');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('danger', data.message, '错误');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('danger', '更新状态失败，请稍后重试', '错误');
    });
}

// 删除留言
function deleteContact(contactId) {
    confirmAction(
        '确认删除',
        '确定要删除这条留言吗？删除后无法恢复。',
        function() {
            fetch(`/admin/contacts/${contactId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message, '成功');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('danger', data.message, '错误');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('danger', '删除失败，请稍后重试', '错误');
            });
        }
    );
}

// 全选/取消全选
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.contact-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });

    updateBatchActions();
}

// 更新批量操作按钮状态
function updateBatchActions() {
    const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
    const count = checkboxes.length;
    const batchActions = document.getElementById('batchActions');
    const selectedCount = document.getElementById('selectedCount');

    if (count > 0) {
        batchActions.style.display = 'block';
        selectedCount.textContent = count;
    } else {
        batchActions.style.display = 'none';
    }
}

// 批量标记为已处理
function batchMarkAsHandled() {
    batchUpdateStatus('handled');
}

// 批量标记为未读
function batchMarkAsUnread() {
    batchUpdateStatus('unread');
}

// 批量更新状态
function batchUpdateStatus(status) {
    const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

    if (ids.length === 0) {
        showToast('warning', '请先选择留言', '提示');
        return;
    }

    const statusText = status === 'handled' ? '已处理' : '未读';
    confirmAction(
        '批量操作确认',
        `确定将选中的 ${ids.length} 条留言标记为${statusText}吗？`,
        function() {
            fetch('/contacts/batch/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ids: ids,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message, '成功');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('danger', data.message, '错误');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('danger', '批量更新失败，请稍后重试', '错误');
            });
        }
    );
}

// 清除选择
function clearSelection() {
    const checkboxes = document.querySelectorAll('.contact-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateBatchActions();
}

// 导出 CSV
function exportCSV() {
    // 获取当前的筛选条件
    const urlParams = new URLSearchParams(window.location.search);
    const statusFilter = urlParams.get('status_filter') || '';
    const keyword = urlParams.get('keyword') || '';

    // 构建导出 URL
    let exportUrl = '/contacts/export/csv?';
    if (statusFilter) {
        exportUrl += `status_filter=${statusFilter}&`;
    }
    if (keyword) {
        exportUrl += `keyword=${encodeURIComponent(keyword)}`;
    }

    // 下载文件
    window.location.href = exportUrl;
    showToast('info', '正在导出数据，请稍候...', '提示');
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化所有 tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
