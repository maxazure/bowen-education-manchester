{% extends "base.html" %}

{% block title %}访问统计 - 博文教育管理后台{% endblock %}

{% block extra_css %}
<style>
.stat-card-mini {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0.5rem;
    padding: 1rem;
}

.stat-card-mini.green {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.stat-card-mini.orange {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-card-mini.blue {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-card-mini.red {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.trend-chart-container {
    height: 250px;
}

.device-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 1.2rem;
}

.device-desktop { background: #e3f2fd; color: #1976d2; }
.device-mobile { background: #fce4ec; color: #c2185b; }
.device-tablet { background: #f3e5f5; color: #7b1fa2; }

/* 增强的卡片样式 */
.analytics-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.analytics-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* 进度条样式 */
.progress-thin {
    height: 6px;
    border-radius: 3px;
}

/* 对比统计卡片 */
.comparison-card {
    border-left: 4px solid #667eea;
}

.comparison-card.positive {
    border-left-color: #38ef7d;
}

.comparison-card.negative {
    border-left-color: #f5576c;
}

/* 雷达图容器 */
.radar-container {
    height: 280px;
    position: relative;
}

/* 小时分布热力图 */
.hourly-heatmap {
    display: grid;
    grid-template-columns: repeat(24, 1fr);
    gap: 2px;
}

.hour-cell {
    aspect-ratio: 1;
    border-radius: 3px;
    background: #e9ecef;
    transition: all 0.2s;
    cursor: pointer;
}

.hour-cell:hover {
    transform: scale(1.2);
    z-index: 1;
}

/* 实时指示器 */
.realtime-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #38ef7d;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block content %}
<!-- 面包屑导航 -->
<nav aria-label="breadcrumb" class="mb-3 animate-fade-in">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin"><i class="bi bi-house-door me-1"></i>首页</a></li>
        <li class="breadcrumb-item active" aria-current="page">访问统计</li>
    </ol>
</nav>

<!-- 页面标题区 -->
<div class="page-header animate-fade-in">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="bi bi-bar-chart-line text-primary me-2"></i>访问统计
                <span class="realtime-indicator ms-2" title="实时数据"></span>
            </h1>
            <p class="page-subtitle">分析网站访问数据，了解用户行为</p>
        </div>
        <div class="d-flex gap-2">
            <!-- 时间范围选择 -->
            <div class="btn-group">
                <a href="/admin/analytics?days=7"
                   class="btn {% if stats.days == 7 %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    最近7天
                </a>
                <a href="/admin/analytics?days=14"
                   class="btn {% if stats.days == 14 %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    最近14天
                </a>
                <a href="/admin/analytics?days=30"
                   class="btn {% if stats.days == 30 %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    最近30天
                </a>
            </div>
            <button class="btn btn-outline-secondary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise me-1"></i>刷新
            </button>
            <button class="btn btn-outline-primary" onclick="exportAnalyticsData()">
                <i class="bi bi-download me-1"></i>导出
            </button>
        </div>
    </div>
</div>

<!-- 统计概览 -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card stat-card-mini analytics-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="small opacity-80">总访问量</div>
                    <div class="fs-2 fw-bold" id="totalVisits">{{ "{:,}".format(stats.total_visits) }}</div>
                </div>
                <div class="stat-icon">
                    <i class="bi bi-eye fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card-mini green analytics-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="small opacity-80">今日访问</div>
                    <div class="fs-2 fw-bold" id="todayVisits">{{ "{:,}".format(stats.today_visits) }}</div>
                </div>
                <div class="stat-icon">
                    <i class="bi bi-calendar-check fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card-mini orange analytics-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="small opacity-80">本周对比</div>
                    <div class="fs-2 fw-bold" id="weekComparison">-</div>
                    <div class="small opacity-80" id="weekChangeText">加载中...</div>
                </div>
                <div class="stat-icon">
                    <i class="bi bi-arrow-up-down fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card-mini blue analytics-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="small opacity-80">监测天数</div>
                    <div class="fs-2 fw-bold">{{ stats.days }} 天</div>
                </div>
                <div class="stat-icon">
                    <i class="bi bi-clock-history fs-1"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row g-3 mb-4">
    <!-- 访问趋势图 -->
    <div class="col-lg-8">
        <div class="card animate-fade-in">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up text-primary me-2"></i>访问趋势
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline active" id="trendLine" onclick="switchTrendChart('line')">
                        <i class="bi bi-bar-chart-steps"></i> 折线
                    </button>
                    <button class="btn btn-outline" id="trendBar" onclick="switchTrendChart('bar')">
                        <i class="bi bi-bar-chart"></i> 柱状
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="trend-chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 设备分布 -->
    <div class="col-lg-4">
        <div class="card animate-fade-in">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-phone text-primary me-2"></i>设备分布
                </h5>
            </div>
            <div class="card-body">
                <div style="height: 200px;">
                    <canvas id="deviceChart"></canvas>
                </div>
                <div class="mt-3">
                    {% for device in device_stats %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="device-icon device-{{ device.device_type }}">
                                {% if device.device_type == 'desktop' %}
                                <i class="bi bi-pc-display"></i>
                                {% elif device.device_type == 'mobile' %}
                                <i class="bi bi-phone"></i>
                                {% else %}
                                <i class="bi bi-tablet"></i>
                                {% endif %}
                            </div>
                            <span class="ms-2">
                                {% if device.device_type == 'desktop' %}桌面端
                                {% elif device.device_type == 'mobile' %}移动端
                                {% else %}平板{% endif %}
                            </span>
                        </div>
                        <span class="badge bg-primary">{{ device.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细分析区域 -->
<div class="row g-3 mb-4">
    <!-- 小时访问分布 -->
    <div class="col-lg-6">
        <div class="card animate-fade-in">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock text-primary me-2"></i>24小时访问分布
                </h5>
                <span class="badge bg-secondary">热力图</span>
            </div>
            <div class="card-body">
                <div class="hourly-heatmap" id="hourlyHeatmap">
                    <!-- 24小时热力单元格 -->
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span class="small text-muted">0:00</span>
                    <span class="small text-muted">6:00</span>
                    <span class="small text-muted">12:00</span>
                    <span class="small text-muted">18:00</span>
                    <span class="small text-muted">23:00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作系统分布 -->
    <div class="col-lg-6">
        <div class="card animate-fade-in">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title mb-0">
                    <i class="bi bi-laptop text-primary me-2"></i>操作系统分布
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadOSDistribution()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                <div style="height: 200px;">
                    <canvas id="osChart"></canvas>
                </div>
                <div class="mt-3" id="osLegend">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-hourglass-split me-2"></i>点击刷新加载数据
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细数据 -->
<div class="row g-3">
    <!-- 热门页面 -->
    <div class="col-lg-8">
        <div class="card animate-fade-in">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-fire text-primary me-2"></i>热门页面 TOP 10
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>页面</th>
                                <th style="width: 120px;">访问量</th>
                                <th style="width: 180px;">最后访问</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in top_pages %}
                            <tr>
                                <td class="text-muted">{{ loop.index }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-file-earmark-text text-muted me-2"></i>
                                        <div>
                                            <div class="fw-medium">{{ page.page_title or '未命名' }}</div>
                                            <small class="text-muted">{{ page.page_path }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ "{:,}".format(page.visit_count) }}</span>
                                </td>
                                <td class="text-muted small">
                                    {% if page.last_visited_at %}
                                    {{ page.last_visited_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 浏览器分布 -->
    <div class="col-lg-4">
        <div class="card animate-fade-in">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-globe text-primary me-2"></i>浏览器分布
                </h5>
            </div>
            <div class="card-body">
                {% for browser in browser_stats %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-browser-chrome text-muted me-2"></i>
                        <span>{{ browser.browser }}</span>
                    </div>
                    <div class="flex-grow-1 mx-3">
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: {{ (browser.count / (browser_stats[0].count if browser_stats[0] else 1)) * 100 }}%"></div>
                        </div>
                    </div>
                    <span class="badge bg-secondary">{{ browser.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 跟踪代码 -->
        <div class="card mt-3 animate-fade-in">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-code-slash text-primary me-2"></i>跟踪代码
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-2">在网站底部添加以下代码以启用访问跟踪：</p>
                <div class="bg-dark p-2 rounded">
                    <code class="text-light small">&lt;script src="/api/analytics/tracking.js"&gt;&lt;/script&gt;</code>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyTrackingCode()">
                    <i class="bi bi-clipboard me-1"></i>复制代码
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 最近访问记录 -->
<div class="card mt-4 animate-fade-in">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-clock-history text-primary me-2"></i>最近访问记录
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>时间</th>
                        <th>页面</th>
                        <th>来源</th>
                        <th>设备</th>
                        <th>浏览器</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_logs %}
                    <tr>
                        <td class="text-muted small">
                            {% if log.visit_time %}
                            {{ log.visit_time.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ log.page_path }}" target="_blank" class="text-decoration-none">
                                {{ log.page_title or log.page_path }}
                            </a>
                        </td>
                        <td class="text-muted small">
                            {% if log.referer %}
                            <span title="{{ log.referer }}">{{ log.referer[:30] }}...</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">
                                {% if log.device_type == 'desktop' %}桌面
                                {% elif log.device_type == 'mobile' %}手机
                                {% else %}平板{% endif %}
                            </span>
                        </td>
                        <td class="text-muted small">{{ log.browser }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let trendChart = null;
let deviceChart = null;
let osChart = null;
let currentTrendType = 'line';
let hourlyData = null;

// 初始化图表
document.addEventListener('DOMContentLoaded', function() {
    initTrendChart();
    initDeviceChart();
    initHourlyHeatmap();
    loadComparisonData();
});

// 访问趋势图
function initTrendChart() {
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;

    const dailyData = {{ daily_stats | tojson }};
    const labels = dailyData.map(d => d.date ? d.date.substring(5) : '');
    const data = dailyData.map(d => d.visits);

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '访问量',
                data: data,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: {
                    grid: { display: false }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// 切换趋势图类型
function switchTrendChart(type) {
    currentTrendType = type;
    document.getElementById('trendLine').classList.toggle('active', type === 'line');
    document.getElementById('trendBar').classList.toggle('active', type === 'bar');

    if (trendChart) {
        trendChart.config.type = type;
        trendChart.options.plugins.legend = { display: false };
        if (type === 'bar') {
            trendChart.options.plugins.legend = { display: true };
            trendChart.data.datasets[0].backgroundColor = 'rgba(102, 126, 234, 0.6)';
        } else {
            trendChart.data.datasets[0].backgroundColor = 'rgba(102, 126, 234, 0.1)';
        }
        trendChart.update();
    }
}

// 设备分布图
function initDeviceChart() {
    const ctx = document.getElementById('deviceChart');
    if (!ctx) return;

    const deviceData = {{ device_stats | tojson }};
    const labels = deviceData.map(d => {
        if (d.device_type === 'desktop') return '桌面端';
        if (d.device_type === 'mobile') return '移动端';
        return '平板';
    });
    const data = deviceData.map(d => d.count);
    const colors = ['#667eea', '#38ef7d', '#f5576c'];

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ${context.raw} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// 初始化小时热力图
function initHourlyHeatmap() {
    const container = document.getElementById('hourlyHeatmap');
    if (!container) return;

    // 获取URL参数中的days
    const urlParams = new URLSearchParams(window.location.search);
    const days = urlParams.get('days') || 7;

    // 获取小时分布数据
    fetch(`/api/analytics/hourly?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                hourlyData = data.data;
                renderHourlyHeatmap(hourlyData);
            }
        })
        .catch(() => {
            // 如果请求失败，使用模拟数据生成热力图
            renderHourlyHeatmap([]);
        });
}

function renderHourlyHeatmap(data) {
    const container = document.getElementById('hourlyHeatmap');
    if (!container) return;

    // 创建小时数据映射
    const dataMap = {};
    data.forEach(item => {
        dataMap[item.hour] = item.count;
    });

    // 找出最大值用于计算颜色
    const maxCount = Math.max(...Object.values(dataMap), 1);

    // 生成24个单元格
    for (let hour = 0; hour < 24; hour++) {
        const count = dataMap[hour] || 0;
        const intensity = count / maxCount;
        const cell = document.createElement('div');
        cell.className = 'hour-cell';
        cell.title = `${hour}:00 - ${count} 次访问`;

        // 根据强度计算颜色 (从浅灰到深蓝)
        const r = 233 - intensity * 200;
        const g = 236 - intensity * 180;
        const b = 239 - intensity * 100;
        cell.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;

        if (intensity > 0.6) {
            cell.style.color = 'white';
            cell.style.fontWeight = 'bold';
        }

        container.appendChild(cell);
    }
}

// 加载对比数据
async function loadComparisonData() {
    try {
        const response = await fetch('/api/analytics/compare');
        const data = await response.json();

        if (data.success) {
            const change = data.data.visit_change;
            const comparisonEl = document.getElementById('weekComparison');
            const changeTextEl = document.getElementById('weekChangeText');

            comparisonEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(1) + '%';
            changeTextEl.textContent = `本周 vs 上周 ${change >= 0 ? '↑' : '↓'}`;

            // 根据变化设置颜色
            const card = comparisonEl.closest('.stat-card-mini');
            card.classList.remove('orange', 'green', 'red');
            if (change > 0) {
                card.classList.add('green');
            } else if (change < 0) {
                card.classList.add('red');
            }
        }
    } catch (e) {
        console.log('对比数据加载失败');
    }
}

// 加载操作系统分布
function loadOSDistribution() {
    const urlParams = new URLSearchParams(window.location.search);
    const days = urlParams.get('days') || 7;

    const legendEl = document.getElementById('osLegend');
    legendEl.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm me-2"></div>加载中...</div>';

    fetch(`/api/analytics/os-distribution?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                renderOSChart(data.data);
            } else {
                legendEl.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-info-circle me-2"></i>暂无数据</div>';
            }
        })
        .catch(() => {
            legendEl.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-exclamation-triangle me-2"></i>加载失败</div>';
        });
}

function renderOSChart(osData) {
    const ctx = document.getElementById('osChart');
    const legendEl = document.getElementById('osLegend');

    if (!ctx) return;

    // 如果已存在图表，先销毁
    if (osChart) {
        osChart.destroy();
    }

    const labels = osData.map(d => d.os || 'Unknown');
    const data = osData.map(d => d.count);
    const colors = ['#667eea', '#38ef7d', '#f5576c', '#ffc107', '#17a2b8', '#6c757d', '#28a745', '#dc3545', '#0d6efd', '#6610f2'];

    osChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '访问量',
                data: data,
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 0,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                y: {
                    grid: { display: false }
                }
            }
        }
    });

    // 渲染图例
    legendEl.innerHTML = osData.map((item, index) => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center">
                <div style="width: 12px; height: 12px; border-radius: 2px; background: ${colors[index]}; margin-right: 8px;"></div>
                <span>${item.os || 'Unknown'}</span>
            </div>
            <span class="badge bg-secondary">${item.count}</span>
        </div>
    `).join('');
}

// 刷新数据
function refreshData() {
    location.reload();
}

// 导出分析数据
function exportAnalyticsData() {
    const urlParams = new URLSearchParams(window.location.search);
    const days = urlParams.get('days') || 7;

    window.location.href = `/admin/api/export/analytics?date_from=${days}&format=json`;
}

// 复制跟踪代码
function copyTrackingCode() {
    const code = '<script src="/api/analytics/tracking.js"><\/script>';
    navigator.clipboard.writeText(code).then(() => {
        showToast('跟踪代码已复制到剪贴板', 'success');
    });
}
</script>
{% endblock %}
