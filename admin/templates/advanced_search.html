{% extends "base.html" %}

{% block title %}高级搜索 - 博文教育管理后台{% endblock %}

{% block content %}
<!-- 面包屑导航 -->
<nav aria-label="breadcrumb" class="mb-3 animate-fade-in">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin"><i class="bi bi-house-door me-1"></i>首页</a></li>
        <li class="breadcrumb-item active" aria-current="page">高级搜索</li>
    </ol>
</nav>

<!-- 页面标题区 -->
<div class="page-header animate-fade-in">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="bi bi-search text-primary me-2"></i>高级搜索
            </h1>
            <p class="page-subtitle">多维度筛选和搜索内容</p>
        </div>
    </div>
</div>

<!-- 搜索区域 -->
<div class="card mb-4 animate-fade-in">
    <div class="card-body">
        <!-- 关键词搜索 -->
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group input-group-lg">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchKeyword" class="form-control"
                           placeholder="输入关键词搜索标题、内容、摘要..."
                           value="{{ keyword or '' }}">
                    <button class="btn btn-primary" onclick="doSearch()">
                        <i class="bi bi-search me-1"></i>搜索
                    </button>
                </div>
                <!-- 搜索建议 -->
                <div id="suggestions" class="position-absolute bg-white shadow-sm rounded border mt-1"
                     style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto; width: calc(100% - 30px);"></div>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="toggleAdvanced()">
                        <i class="bi bi-funnel me-1"></i>高级筛选
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="bi bi-x-lg me-1"></i>清除
                    </button>
                </div>
            </div>
        </div>

        <!-- 高级筛选面板 -->
        <div id="advancedFilters" class="border-top pt-3" style="display: none;">
            <div class="row g-3">
                <!-- 内容类型 -->
                <div class="col-md-3">
                    <label class="form-label">内容类型</label>
                    <div class="form-check-group">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="contentType" value="post" id="typePost" checked>
                            <label class="form-check-label" for="typePost">文章</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="contentType" value="product" id="typeProduct" checked>
                            <label class="form-check-label" for="typeProduct">产品</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="contentType" value="gallery" id="typeGallery" checked>
                            <label class="form-check-label" for="typeGallery">相册</label>
                        </div>
                    </div>
                </div>

                <!-- 状态筛选 -->
                <div class="col-md-3">
                    <label class="form-label">状态</label>
                    <select class="form-select" id="filterStatus" multiple style="height: 100px;">
                        <option value="published">已发布</option>
                        <option value="draft">草稿</option>
                        <option value="offline">已下线</option>
                    </select>
                    <small class="text-muted">按住 Ctrl 选择多个</small>
                </div>

                <!-- 栏目筛选 -->
                <div class="col-md-3">
                    <label class="form-label">栏目</label>
                    <select class="form-select" id="filterColumn" multiple style="height: 100px;">
                        {% for col in columns %}
                        <option value="{{ col.id }}">{{ col.name }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">按住 Ctrl 选择多个</small>
                </div>

                <!-- 日期范围 -->
                <div class="col-md-3">
                    <label class="form-label">日期范围</label>
                    <div class="input-group mb-2">
                        <input type="date" class="form-control form-control-sm" id="dateFrom" placeholder="开始日期">
                        <span class="input-group-text">至</span>
                        <input type="date" class="form-control form-control-sm" id="dateTo" placeholder="结束日期">
                    </div>
                </div>

                <!-- 其他筛选 -->
                <div class="col-md-12">
                    <label class="form-label">其他条件</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="hasImage">
                        <label class="form-check-label" for="hasImage">有封面图</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="isRecommended">
                        <label class="form-check-label" for="isRecommended">推荐内容</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="isPinned">
                        <label class="form-check-label" for="isPinned">置顶内容</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 搜索结果统计 -->
<div class="d-flex justify-content-between align-items-center mb-3 animate-fade-in">
    <div>
        <span class="text-muted">找到 </span>
        <strong id="totalResults" class="text-primary">0</strong>
        <span class="text-muted"> 条结果</span>
    </div>
    <div class="d-flex gap-2">
        <select class="form-select form-select-sm" id="sortBy" style="width: auto;" onchange="doSearch()">
            <option value="relevance">相关度</option>
            <option value="date_desc">最新优先</option>
            <option value="date_asc">最早优先</option>
            <option value="title">标题排序</option>
        </select>
        <select class="form-select form-select-sm" id="viewMode" style="width: auto;" onchange="toggleViewMode()">
            <option value="list">列表视图</option>
            <option value="grid">网格视图</option>
        </select>
    </div>
</div>

<!-- 搜索结果 - 选项卡切换 -->
<ul class="nav nav-tabs mb-3 animate-fade-in" id="resultTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#allResults" type="button">
            全部 <span class="badge bg-primary ms-1" id="countAll">0</span>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#postResults" type="button">
            文章 <span class="badge bg-primary ms-1" id="countPosts">0</span>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#productResults" type="button">
            产品 <span class="badge bg-primary ms-1" id="countProducts">0</span>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#galleryResults" type="button">
            相册 <span class="badge bg-primary ms-1" id="countGalleries">0</span>
        </button>
    </li>
</ul>

<!-- 搜索结果内容 -->
<div class="tab-content animate-fade-in" id="searchResults">
    <!-- 全部结果 -->
    <div class="tab-pane fade show active" id="allResults">
        <div id="resultsList" class="list-group list-group-flush">
            <div class="text-center py-5 text-muted">
                <i class="bi bi-search fs-1 d-block mb-3"></i>
                <p class="mb-0">输入关键词开始搜索</p>
            </div>
        </div>
    </div>

    <!-- 文章结果 -->
    <div class="tab-pane fade" id="postResults">
        <div id="postsList" class="list-group list-group-flush"></div>
    </div>

    <!-- 产品结果 -->
    <div class="tab-pane fade" id="productResults">
        <div id="productsList" class="row g-3"></div>
    </div>

    <!-- 相册结果 -->
    <div class="tab-pane fade" id="galleryResults">
        <div id="galleriesList" class="row g-3"></div>
    </div>
</div>

<!-- 分页 -->
<nav class="mt-4" id="paginationNav" style="display: none;">
    <ul class="pagination justify-content-center" id="pagination">
    </ul>
</nav>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 关键词输入建议
    const keywordInput = document.getElementById('searchKeyword');
    let debounceTimer;

    keywordInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const q = this.value.trim();
            if (q.length >= 2) {
                loadSuggestions(q);
            } else {
                hideSuggestions();
            }
        }, 300);
    });

    // 点击其他地方关闭建议
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#searchKeyword') && !e.target.closest('#suggestions')) {
            hideSuggestions();
        }
    });

    // 回车搜索
    keywordInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            doSearch();
        }
    });
});

// 加载搜索建议
async function loadSuggestions(q) {
    try {
        const response = await fetch(`/admin/api/search/suggestions?q=${encodeURIComponent(q)}`);
        const data = await response.json();

        if (data.success && data.data.length > 0) {
            showSuggestions(data.data);
        } else {
            hideSuggestions();
        }
    } catch (error) {
        hideSuggestions();
    }
}

function showSuggestions(suggestions) {
    const container = document.getElementById('suggestions');
    let html = '';

    suggestions.forEach(item => {
        html += `
            <div class="px-3 py-2 border-bottom cursor-pointer" onclick="selectSuggestion('${item.text}')">
                <i class="bi bi-${item.icon} text-muted me-2"></i>
                ${item.text}
            </div>
        `;
    });

    container.innerHTML = html;
    container.style.display = 'block';
}

function hideSuggestions() {
    document.getElementById('suggestions').style.display = 'none';
}

function selectSuggestion(text) {
    document.getElementById('searchKeyword').value = text;
    hideSuggestions();
    doSearch();
}

// 切换高级筛选
function toggleAdvanced() {
    const panel = document.getElementById('advancedFilters');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// 清除筛选
function clearFilters() {
    document.getElementById('searchKeyword').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('hasImage').checked = false;
    document.getElementById('isRecommended').checked = false;
    document.getElementById('isPinned').checked = false;

    // 重置多选
    document.querySelectorAll('#filterStatus option').forEach(o => o.selected = false);
    document.querySelectorAll('#filterColumn option').forEach(o => o.selected = false);
    document.querySelectorAll('input[name="contentType"]').forEach(cb => cb.checked = true);
}

// 执行搜索
async function doSearch(page = 1) {
    const keyword = document.getElementById('searchKeyword').value.trim();

    if (!keyword) {
        showToast('warning', '请输入关键词', '');
        return;
    }

    currentPage = page;

    // 构建筛选条件
    const filters = {
        keyword: keyword,
        content_type: getSelectedValues('contentType'),
        status: getSelectedValues('filterStatus'),
        column_ids: getSelectedValues('filterColumn').map(Number),
        date_from: document.getElementById('dateFrom').value || null,
        date_to: document.getElementById('dateTo').value || null,
        has_image: document.getElementById('hasImage').checked || null,
        is_recommended: document.getElementById('isRecommended').checked || null,
        is_pinned: document.getElementById('isPinned').checked || null,
    };

    try {
        const response = await fetch('/admin/api/advanced-search', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ...filters,
                page: page,
                page_size: 20
            })
        });

        const data = await response.json();
        if (data.success) {
            renderResults(data.data);
        } else {
            showToast('error', '搜索失败', data.message);
        }
    } catch (error) {
        showToast('error', '搜索失败', error.message);
    }
}

// 获取选中的值
function getSelectedValues(name) {
    const checked = document.querySelectorAll(`input[name="${name}"]:checked`);
    const selected = document.querySelectorAll(`select#filter${name.charAt(0).toUpperCase() + name.slice(1)} option:checked`);

    const values = [];
    checked.forEach(cb => values.push(cb.value));
    selected.forEach(opt => values.push(opt.value));

    return values;
}

// 渲染搜索结果
function renderResults(data) {
    const results = data.results;
    const total = data.total;

    // 更新统计
    document.getElementById('totalResults').textContent = total;
    document.getElementById('countAll').textContent = total;
    document.getElementById('countPosts').textContent = results.posts.total;
    document.getElementById('countProducts').textContent = results.products.total;
    document.getElementById('countGalleries').textContent = results.galleries.total;

    // 渲染各类型结果
    renderPosts(results.posts.items);
    renderProducts(results.products.items);
    renderGalleries(results.galleries.items);

    // 渲染全部结果（合并）
    renderAllResults(results);

    // 更新分页
    totalPages = Math.ceil(total / 20);
    updatePagination();
}

// 渲染文章结果
function renderPosts(items) {
    const container = document.getElementById('postsList');

    if (items.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">暂无相关文章</div>';
        return;
    }

    let html = '';
    items.forEach(item => {
        html += `
            <a href="${item.url}" class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge bg-primary me-2">文章</span>
                            <h6 class="mb-0">${item.title}</h6>
                        </div>
                        <p class="text-muted small mb-1">${item.summary || ''}</p>
                        <small class="text-muted">
                            ${item.column_name ? `<i class="bi bi-folder me-1"></i>${item.column_name}` : ''}
                            <span class="ms-2">
                                ${item.status === 'published' ? '<span class="badge bg-success">已发布</span>' :
                                  item.status === 'draft' ? '<span class="badge bg-secondary">草稿</span>' :
                                  '<span class="badge bg-warning">已下线</span>'}
                            </span>
                            ${item.is_recommended ? '<span class="badge bg-warning ms-1">推荐</span>' : ''}
                            ${item.is_pinned ? '<span class="badge bg-info ms-1">置顶</span>' : ''}
                        </small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-chevron-right text-muted"></i>
                    </div>
                </div>
            </a>
        `;
    });

    container.innerHTML = html;
}

// 渲染产品结果
function renderProducts(items) {
    const container = document.getElementById('productsList');

    if (items.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4 text-muted">暂无相关产品</div>';
        return;
    }

    let html = '';
    items.forEach(item => {
        html += `
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${item.name}</h6>
                        <p class="text-muted small">${item.status}</p>
                        <a href="${item.url}" class="btn btn-sm btn-outline-primary">编辑</a>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// 渲染相册结果
function renderGalleries(items) {
    const container = document.getElementById('galleriesList');

    if (items.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4 text-muted">暂无相关相册</div>';
        return;
    }

    let html = '';
    items.forEach(item => {
        html += `
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${item.title}</h6>
                        <p class="text-muted small">${item.status}</p>
                        <a href="${item.url}" class="btn btn-sm btn-outline-primary">编辑</a>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// 渲染全部结果
function renderAllResults(results) {
    const container = document.getElementById('resultsList');
    let html = '';

    // 合并所有结果
    const allItems = [
        ...results.posts.items.map(i => ({...i, content_type: 'post'})),
        ...results.products.items.map(i => ({...i, content_type: 'product'})),
        ...results.galleries.items.map(i => ({...i, content_type: 'gallery'})),
    ];

    if (allItems.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-search fs-1 d-block mb-3 text-muted"></i>
                <p class="text-muted mb-2">没有找到相关结果</p>
                <p class="text-muted small">请尝试其他关键词或调整筛选条件</p>
            </div>
        `;
        return;
    }

    allItems.forEach(item => {
        const typeLabels = {
            'post': {badge: 'bg-primary', text: '文章'},
            'product': {badge: 'bg-success', text: '产品'},
            'gallery': {badge: 'bg-info', text: '相册'},
        };
        const typeInfo = typeLabels[item.content_type];

        html += `
            <a href="${item.url}" class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge ${typeInfo.badge} me-2">${typeInfo.text}</span>
                            <h6 class="mb-0">${item.title || item.name}</h6>
                        </div>
                        <small class="text-muted">
                            ${item.column_name ? `<i class="bi bi-folder me-1"></i>${item.column_name}` : ''}
                            <span class="ms-2">${item.created_at ? item.created_at.split('T')[0] : ''}</span>
                        </small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-chevron-right text-muted"></i>
                    </div>
                </div>
            </a>
        `;
    });

    container.innerHTML = html;
}

// 更新分页
function updatePagination() {
    const nav = document.getElementById('paginationNav');
    const container = document.getElementById('pagination');

    if (totalPages <= 1) {
        nav.style.display = 'none';
        return;
    }

    nav.style.display = 'flex';

    let html = '';

    // 上一页
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <button class="page-link" onclick="doSearch(${currentPage - 1})">上一页</button>
        </li>
    `;

    // 页码
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <button class="page-link" onclick="doSearch(${i})">${i}</button>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    // 下一页
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <button class="page-link" onclick="doSearch(${currentPage + 1})">下一页</button>
        </li>
    `;

    container.innerHTML = html;
}

// 切换视图模式
function toggleViewMode() {
    const mode = document.getElementById('viewMode').value;
    localStorage.setItem('searchViewMode', mode);
}
</script>
{% endblock %}
