{% extends "base.html" %}

{% block title %}{% if product %}编辑产品{% else %}新建产品{% endif %} - 博文教育管理后台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
{% endblock %}

{% block content %}
<div class="form-container">
    <!-- 页面头部 -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title mb-1">
                <i class="bi bi-{% if product %}pencil-square{% else %}plus-circle{% endif %} me-2"></i>
                {% if product %}编辑产品{% else %}新建产品{% endif %}
            </h1>
            <p class="page-subtitle mb-0">
                {% if product %}
                更新产品信息和内容
                {% else %}
                创建一个新的产品
                {% endif %}
            </p>
        </div>
        <div>
            <a href="/admin/products" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </div>

    <!-- 表单内容 -->
    <form method="POST" action="{{ action }}" id="productForm" class="needs-validation" novalidate>
        <div class="form-layout">
            <!-- 左侧主要内容 -->
            <div class="form-main">
                <!-- 基本信息卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle me-2"></i>基本信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- 产品名称 -->
                        <div class="mb-3">
                            <label for="name" class="form-label">
                                产品名称 <span class="text-danger">*</span>
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                id="name"
                                name="name"
                                value="{{ product.name if product else '' }}"
                                required
                                placeholder="请输入产品名称">
                            <div class="invalid-feedback">
                                请输入产品名称
                            </div>
                        </div>

                        <!-- Slug -->
                        <div class="mb-3">
                            <label for="slug" class="form-label">
                                URL Slug
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                id="slug"
                                name="slug"
                                value="{{ product.slug if product else '' }}"
                                placeholder="留空自动生成">
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i>
                                <span>URL 友好的标识符，留空将根据产品名称自动生成</span>
                            </div>
                        </div>

                        <!-- 产品卖点 -->
                        <div class="mb-0">
                            <label for="summary" class="form-label">
                                产品卖点 / 简述
                            </label>
                            <textarea
                                class="form-control"
                                id="summary"
                                name="summary"
                                rows="3"
                                placeholder="请输入产品卖点或简短描述">{{ product.summary if product else '' }}</textarea>
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i>
                                <span>简短描述产品特点，用于列表展示</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 产品详情卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-file-text me-2"></i>产品详情
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-0">
                            <label for="description_markdown" class="form-label">
                                产品详细说明 (Markdown) <span class="text-danger">*</span>
                            </label>
                            <textarea
                                id="description_markdown"
                                name="description_markdown"
                                required>{{ product.description_html if product else '' }}</textarea>
                            <div class="invalid-feedback">
                                请输入产品详情
                            </div>
                            <div class="help-text">
                                <i class="bi bi-markdown"></i>
                                <span>支持 Markdown 格式编辑，实时预览内容效果</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 价格信息卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-currency-dollar me-2"></i>价格信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- 价格文本 -->
                        <div class="mb-3">
                            <label for="price_text" class="form-label">
                                价格文本
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                id="price_text"
                                name="price_text"
                                value="{{ product.price_text if product else '' }}"
                                placeholder="例如: ¥999 或 ¥1999 (原价 ¥2999)">
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i>
                                <span>灵活的价格展示文本，可以包含原价、优惠等信息</span>
                            </div>
                        </div>

                        <!-- 供货状态 -->
                        <div class="mb-0">
                            <label for="availability_status" class="form-label">
                                供货状态
                            </label>
                            <select class="form-select" id="availability_status" name="availability_status">
                                <option value="in_stock" {% if not product or product.availability_status == 'in_stock' %}selected{% endif %}>
                                    有货
                                </option>
                                <option value="out_of_stock" {% if product and product.availability_status == 'out_of_stock' %}selected{% endif %}>
                                    缺货
                                </option>
                                <option value="inquiry" {% if product and product.availability_status == 'inquiry' %}selected{% endif %}>
                                    询价
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SEO 设置卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-search me-2"></i>SEO 设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- SEO 标题 -->
                        <div class="mb-3">
                            <label for="seo_title" class="form-label">
                                SEO 标题
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                id="seo_title"
                                name="seo_title"
                                value="{{ product.seo_title if product else '' }}"
                                placeholder="留空使用产品名称">
                        </div>

                        <!-- SEO 描述 -->
                        <div class="mb-0">
                            <label for="seo_description" class="form-label">
                                SEO 描述
                            </label>
                            <textarea
                                class="form-control"
                                id="seo_description"
                                name="seo_description"
                                rows="3"
                                placeholder="用于搜索引擎显示的描述">{{ product.seo_description if product else '' }}</textarea>
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i>
                                <span>建议长度 120-160 字符，用于搜索引擎结果展示</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 表单操作按钮 -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>
                        {% if product %}更新产品{% else %}创建产品{% endif %}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/products'">
                        <i class="bi bi-x-circle me-2"></i>
                        取消
                    </button>
                </div>
            </div>

            <!-- 右侧侧边栏 -->
            <div class="form-sidebar">
                <!-- 发布设置 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-send me-2"></i>发布设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">
                                <i class="bi bi-journal-text"></i>
                                <span>所属栏目</span>
                            </div>
                            <select class="form-select" id="column_id" name="column_id" required>
                                <option value="">-- 选择栏目 --</option>
                                {% for col in columns %}
                                <option value="{{ col.id }}" {% if product and col.id == product.column_id %}selected{% endif %}>
                                    {{ col.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                请选择产品所属栏目
                            </div>
                        </div>

                        <div class="sidebar-section">
                            <div class="sidebar-section-title">
                                <i class="bi bi-toggle-on"></i>
                                <span>状态</span>
                            </div>
                            <select class="form-select" id="status" name="status">
                                <option value="draft" {% if not product or product.status == 'draft' %}selected{% endif %}>
                                    草稿
                                </option>
                                <option value="online" {% if product and product.status == 'online' %}selected{% endif %}>
                                    上线
                                </option>
                                <option value="offline" {% if product and product.status == 'offline' %}selected{% endif %}>
                                    下线
                                </option>
                            </select>
                        </div>

                        <div class="sidebar-section mb-0">
                            <div class="sidebar-section-title">
                                <i class="bi bi-star"></i>
                                <span>特殊标记</span>
                            </div>

                            <div class="form-check form-switch mb-0">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    id="is_recommended"
                                    name="is_recommended"
                                    value="1"
                                    {% if product and product.is_recommended %}checked{% endif %}>
                                <label class="form-check-label" for="is_recommended">
                                    <i class="bi bi-heart text-danger me-1"></i>推荐产品
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 产品分类 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-folder me-2"></i>产品分类
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if categories %}
                        <div class="category-checkboxes">
                            {% for category in categories %}
                            <div class="form-check">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    name="category_checkbox"
                                    value="{{ category.id }}"
                                    id="category_{{ category.id }}"
                                    {% if product and category in product.categories %}checked{% endif %}>
                                <label class="form-check-label" for="category_{{ category.id }}">
                                    {{ category.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="category_ids" id="category_ids" value="{% if product %}{{ product.categories|map(attribute='id')|join(',') }}{% endif %}">
                        <div class="help-text mt-2">
                            <i class="bi bi-info-circle"></i>
                            <span>可以选择多个分类</span>
                        </div>
                        {% else %}
                        <div class="empty-categories">
                            <i class="bi bi-folder-x d-block"></i>
                            <p class="mb-0">暂无分类</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- 封面图片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-image me-2"></i>封面图片
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-section mb-0">
                            <div class="sidebar-section-title">
                                <i class="bi bi-image"></i>
                                <span>封面图片</span>
                            </div>
                            <input
                                type="number"
                                class="form-control"
                                id="cover_media_id"
                                name="cover_media_id"
                                value="{{ product.cover_media_id if product else '' }}"
                                placeholder="输入媒体 ID">
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i>
                                <span>请输入媒体库中图片的 ID</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
(function() {
    'use strict';

    // 初始化 EasyMDE Markdown 编辑器
    const easyMDE = new EasyMDE({
        element: document.getElementById('description_markdown'),
        spellChecker: false,
        autosave: {
            enabled: true,
            uniqueId: 'product-description-' + ({{ product.id if product else 0 }}),
            delay: 5000,
        },
        placeholder: '请输入产品详细说明，支持 Markdown 格式...',
        minHeight: '400px',
        maxHeight: '600px',
        toolbar: [
            'bold', 'italic', 'heading', '|',
            'quote', 'unordered-list', 'ordered-list', '|',
            'link', 'image', '|',
            'preview', 'side-by-side', 'fullscreen', '|',
            'guide'
        ],
        status: ['autosave', 'lines', 'words', 'cursor'],
        renderingConfig: {
            codeSyntaxHighlighting: true,
        }
    });

    // 分类复选框处理
    const categoryCheckboxes = document.querySelectorAll('input[name="category_checkbox"]');
    const categoryIdsInput = document.getElementById('category_ids');

    function updateCategoryIds() {
        const selectedIds = Array.from(categoryCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        categoryIdsInput.value = selectedIds.join(',');
    }

    categoryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCategoryIds);
    });

    // Bootstrap 表单验证
    const form = document.getElementById('productForm');

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        event.stopPropagation();

        // 验证表单
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        // 提交表单
        submitForm();
    });

    // AJAX 提交表单
    function submitForm() {
        const formData = new FormData(form);

        // 处理复选框值（确保布尔值正确传递）
        formData.set('is_recommended', document.getElementById('is_recommended').checked);

        // 获取 Markdown 内容
        formData.set('description_markdown', easyMDE.value());

        // 显示加载状态
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message, '成功');

                // 延迟跳转到列表页
                setTimeout(() => {
                    window.location.href = '/products';
                }, 1500);
            } else {
                showToast('danger', data.message, '错误');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('danger', '提交失败: ' + error.message, '错误');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }

    // 自动生成 Slug（可选功能）
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');

    nameInput.addEventListener('blur', function() {
        if (!slugInput.value && nameInput.value) {
            // 简单的拼音转换（实际使用可能需要更复杂的处理）
            const slug = nameInput.value
                .toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
            slugInput.value = slug;
        }
    });

    // 防止意外离开页面
    let formChanged = false;

    form.addEventListener('change', function() {
        formChanged = true;
    });

    easyMDE.codemirror.on('change', function() {
        formChanged = true;
    });

    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    // 表单提交后清除警告
    form.addEventListener('submit', function() {
        formChanged = false;
    });

})();
</script>
{% endblock %}
