{% extends "base.html" %}

{% block title %}媒体库 - 博文教育管理后台{% endblock %}

{% block extra_css %}
<style>
/* 拖拽上传区域样式 */
.dropzone {
    border: 2px dashed #c8102e;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    background: #fff5f5;
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
}

.dropzone.dragover {
    background: #fff0f0;
    border-color: #a00d24;
    transform: scale(1.01);
}

.dropzone-icon {
    font-size: 3rem;
    color: #c8102e;
    margin-bottom: 1rem;
}

.dropzone-text {
    font-size: 1.1rem;
    color: #333;
    margin-bottom: 0.5rem;
}

.dropzone-hint {
    font-size: 0.875rem;
    color: #6c757d;
}

/* 上传进度条 */
.upload-progress {
    display: none;
    margin-top: 1rem;
}

.upload-progress.active {
    display: block;
}

/* 存储空间条 */
.storage-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.storage-bar-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.storage-warning {
    background: linear-gradient(90deg, #ffc107, #fd7e14);
}

.storage-danger {
    background: linear-gradient(90deg, #fd7e14, #dc3545);
}

/* 文件类型图表容器 */
.chart-container {
    position: relative;
    height: 150px;
}

/* 最近上传时间线 */
.timeline-item {
    position: relative;
    padding-left: 30px;
    margin-bottom: 1rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: -1rem;
    width: 2px;
    background: #dee2e6;
}

.timeline-item:last-child::before {
    display: none;
}

.timeline-dot {
    position: absolute;
    left: 0;
    top: 4px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #c8102e;
}

/* 快速操作按钮 */
.quick-action-btn {
    transition: all 0.2s ease;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
}

.upload-item {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.upload-item-name {
    font-weight: 500;
    margin-bottom: 0.5rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.upload-item-success {
    color: #198754;
}

.upload-item-error {
    color: #dc3545;
}

/* 媒体库专用样式 */
.media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
}

.media-card {
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    overflow: hidden;
    transition: all 0.3s ease;
    background: white;
    cursor: pointer;
}

.media-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.media-card.selected {
    border-color: #c8102e;
    box-shadow: 0 0 0 2px rgba(200, 16, 46, 0.2);
}

.media-thumbnail {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
}

.media-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.media-thumbnail i {
    font-size: 3rem;
    color: #6c757d;
}

.media-info {
    padding: 0.75rem;
}

.media-title {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.media-meta {
    font-size: 0.75rem;
    color: #6c757d;
}

.media-checkbox {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    width: 1.25rem;
    height: 1.25rem;
    z-index: 10;
}

.media-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: none;
}

.media-card:hover .media-actions {
    display: flex;
    gap: 0.25rem;
}

.folder-tree {
    border-right: 1px solid #dee2e6;
    padding: 1rem;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
}

.folder-item {
    padding: 0.5rem 0.75rem;
    margin: 0.25rem 0;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.folder-item:hover {
    background-color: #f8f9fa;
}

.folder-item.active {
    background-color: #c8102e;
    color: white;
}

.folder-item i {
    margin-right: 0.5rem;
}

/* 列表视图样式 */
.media-list {
    display: none;
}

.media-list.list-view {
    display: table;
    width: 100%;
    border-collapse: collapse;
}

.media-list.list-view .media-card {
    display: table-row;
    border: 1px solid #dee2e6;
    margin-bottom: 0;
}

.media-list.list-view .media-card:hover {
    background-color: #f8f9fa;
}

.media-list.list-view .media-checkbox,
.media-list.list-view .media-actions,
.media-list.list-view .media-thumbnail {
    display: table-cell;
    vertical-align: middle;
}

.media-list.list-view .media-checkbox {
    position: static;
    width: 30px;
    padding: 0 10px;
}

.media-list.list-view .media-thumbnail {
    width: 80px;
    height: 60px;
}

.media-list.list-view .media-info {
    display: table-cell;
    vertical-align: middle;
    padding: 10px;
}

.media-list.list-view .media-actions {
    position: static;
    display: flex;
    gap: 5px;
    padding: 10px;
}

/* 视图切换按钮激活状态 */
.view-mode-active {
    background-color: #c8102e !important;
    color: white !important;
    border-color: #c8102e !important;
}
</style>
{% endblock %}

{% block content %}
{% set select_mode = request.query_params.get('select') == '1' %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{% if select_mode %}选择图片{% else %}媒体库{% endif %}</h2>
            <p class="text-muted mb-0">{% if select_mode %}点击选择一张图片作为封面{% else %}管理网站的静态资源和媒体内容{% endif %}</p>
        </div>
        <div class="d-flex gap-2">
            {% if select_mode %}
            <button type="button" class="btn btn-outline-secondary" onclick="window.close()">
                <i class="bi bi-x-circle me-2"></i>关闭
            </button>
            {% endif %}
            <a href="/admin/media/upload" class="btn btn-primary">
                <i class="bi bi-cloud-upload"></i> 上传文件
            </a>
        </div>
    </div>

    <!-- 拖拽上传区域 -->
    <div class="dropzone" id="dropzoneArea">
        <div class="dropzone-icon">
            <i class="bi bi-cloud-upload"></i>
        </div>
        <div class="dropzone-text">拖拽文件到这里上传</div>
        <div class="dropzone-hint">
            支持 JPG, PNG, GIF, WEBP, PDF 等格式，单个文件最大 10MB<br>
            <span class="text-muted">或</span>
            <a href="/admin/media/upload" class="btn btn-sm btn-outline-primary ms-2 mt-2">
                <i class="bi bi-folder-plus"></i> 浏览文件
            </a>
        </div>
        <input type="file" id="dropzoneInput" multiple accept="image/*,.pdf" style="display: none;">
    </div>

    <!-- 上传进度区域 -->
    <div class="upload-progress" id="uploadProgress">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>上传进度</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearUploadProgress()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div id="uploadList"></div>
    </div>

    <!-- 统计卡片 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                                <i class="bi bi-file-earmark"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="stat-label">总文件数</div>
                            <div class="stat-value">{{ total_files }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stat-icon bg-success bg-opacity-10 text-success">
                                <i class="bi bi-image"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="stat-label">图片</div>
                            <div class="stat-value">{{ total_images }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                                <i class="bi bi-film"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="stat-label">视频</div>
                            <div class="stat-value">{{ total_videos }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stat-icon bg-info bg-opacity-10 text-info">
                                <i class="bi bi-file-text"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="stat-label">文档</div>
                            <div class="stat-value">{{ total_documents }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 存储空间和文件类型分布 -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-hdd text-primary me-2"></i>存储空间使用
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">已使用</span>
                        <span class="fw-bold" id="storageUsed">计算中...</span>
                    </div>
                    <div class="storage-bar mb-2">
                        <div class="storage-bar-fill" id="storageBarFill" style="width: 0%;"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="storagePercent">0%</small>
                        <small class="text-muted">总计 10 GB</small>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-muted small">图片</div>
                            <div class="fw-bold text-success" id="imageSize">-</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">视频</div>
                            <div class="fw-bold text-warning" id="videoSize">-</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">文档</div>
                            <div class="fw-bold text-info" id="docSize">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-pie-chart text-primary me-2"></i>文件类型分布
                    </h6>
                </div>
                <div class="card-body d-flex align-items-center">
                    <div class="chart-container" style="width: 140px;">
                        <canvas id="fileTypeChart"></canvas>
                    </div>
                    <div class="ms-3 flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-success me-2" style="width: 12px; height: 12px;"></span>
                            <span class="small">图片 {{ total_images }} 个</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-warning me-2" style="width: 12px; height: 12px;"></span>
                            <span class="small">视频 {{ total_videos }} 个</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-info me-2" style="width: 12px; height: 12px;"></span>
                            <span class="small">文档 {{ total_documents }} 个</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-secondary me-2" style="width: 12px; height: 12px;"></span>
                            <span class="small">其他 {{ total_files - total_images - total_videos - total_documents }} 个</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history text-primary me-2"></i>最近上传
                    </h6>
                </div>
                <div class="card-body" style="max-height: 180px; overflow-y: auto;">
                    <div id="recentUploads">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 筛选和搜索 -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" action="/media" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">文件类型</label>
                    <select name="file_type" class="form-select" onchange="this.form.submit()">
                        <option value="all" {% if current_file_type == 'all' %}selected{% endif %}>全部</option>
                        <option value="image" {% if current_file_type == 'image' %}selected{% endif %}>图片</option>
                        <option value="video" {% if current_file_type == 'video' %}selected{% endif %}>视频</option>
                        <option value="document" {% if current_file_type == 'document' %}selected{% endif %}>文档</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">搜索</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" name="search" class="form-control"
                               placeholder="搜索文件名..." value="{{ search }}">
                        <button type="submit" class="btn btn-primary">搜索</button>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <a href="/admin/media" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-arrow-clockwise"></i> 重置
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="row">
        <!-- 文件夹侧边栏 -->
        <div class="col-md-2">
            <div class="folder-tree">
                <h6 class="text-muted mb-3">文件夹</h6>
                <div class="folder-item {% if not current_folder_id %}active{% endif %}"
                     onclick="location.href='/media'">
                    <i class="bi bi-folder"></i> 全部文件
                </div>
                {% for folder in folders %}
                <div class="folder-item {% if current_folder_id == folder.id %}active{% endif %}"
                     onclick="location.href='/media?folder_id={{ folder.id }}'">
                    <i class="bi bi-folder"></i> {{ folder.name }}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 文件列表 -->
        <div class="col-md-10">
            <!-- 搜索和筛选栏 -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                    <!-- 搜索框 -->
                    <form action="/admin/media" method="GET" class="d-flex">
                        <input type="text" name="search" class="form-control form-control-sm"
                               placeholder="搜索文件..." value="{{ search or '' }}"
                               style="width: 200px;">
                        <input type="hidden" name="folder_id" value="{{ current_folder_id or '' }}">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>

                    <!-- 快速筛选 -->
                    <div class="btn-group btn-group-sm">
                        <a href="/admin/media{% if current_folder_id %}?folder_id={{ current_folder_id }}{% endif %}"
                           class="btn {% if not current_file_type %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                            全部
                        </a>
                        <a href="/admin/media?file_type=image{% if current_folder_id %}&folder_id={{ current_folder_id }}{% endif %}"
                           class="btn {% if current_file_type == 'image' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                            <i class="bi bi-image"></i> 图片
                        </a>
                        <a href="/admin/media?file_type=video{% if current_folder_id %}&folder_id={{ current_folder_id }}{% endif %}"
                           class="btn {% if current_file_type == 'video' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                            <i class="bi bi-film"></i> 视频
                        </a>
                        <a href="/admin/media?file_type=document{% if current_folder_id %}&folder_id={{ current_folder_id }}{% endif %}"
                           class="btn {% if current_file_type == 'document' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                            <i class="bi bi-file-text"></i> 文档
                        </a>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <!-- 视图模式切换 -->
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" id="gridViewBtn" title="网格视图">
                            <i class="bi bi-grid"></i>
                        </button>
                        <button class="btn btn-outline-secondary" id="listViewBtn" title="列表视图">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>

                    <!-- 批量操作 -->
                    <button class="btn btn-sm btn-outline-secondary" id="selectAllBtn" onclick="toggleSelectAll()">
                        <i class="bi bi-check-square"></i> 全选
                    </button>
                    <div class="btn-group btn-group-sm" id="batchActions" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="batchCopyUrls()" title="复制URL">
                            <i class="bi bi-link-45deg"></i> 复制URL
                        </button>
                        <button class="btn btn-outline-success" onclick="batchDownload()" title="下载">
                            <i class="bi bi-download"></i> 下载
                        </button>
                        <button class="btn btn-outline-danger" onclick="batchDelete()" title="删除">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </div>
                    <span class="text-muted small" id="selectedCount"></span>
                </div>
            </div>

            <!-- 文件统计 -->
            <div class="text-muted mb-3">
                <small>共 <strong>{{ total }}</strong> 个文件</small>
            </div>

            <!-- 文件网格 -->
            {% if files %}
            <div class="media-grid">
                {% for file in files %}
                <div class="media-card" data-id="{{ file.id }}">
                    <input type="checkbox" class="media-checkbox form-check-input" value="{{ file.id }}">

                    <div class="media-actions">
                        <button class="btn btn-sm btn-light" onclick="viewFile({{ file.id }})" title="查看详情">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-light" onclick="deleteFile({{ file.id }})" title="删除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>

                    <div class="media-thumbnail" onclick="viewFile({{ file.id }})">
                        {% if file.file_type == 'image' %}
                            <img src="{{ file.path_thumb or file.path_original }}"
                                 alt="{{ file.filename_original }}"
                                 onerror="this.src='/static/images/placeholder.png'">
                        {% elif file.file_type == 'video' %}
                            <i class="bi bi-film"></i>
                        {% elif file.file_type == 'document' %}
                            <i class="bi bi-file-text"></i>
                        {% else %}
                            <i class="bi bi-file"></i>
                        {% endif %}
                    </div>

                    <div class="media-info">
                        <div class="media-title" title="{{ file.filename_original }}">
                            {{ file.filename_original }}
                        </div>
                        <div class="media-meta">
                            {{ file.size_formatted }}
                            {% if file.width and file.height %}
                            · {{ file.width }}×{{ file.height }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- 分页 -->
            {% if total_pages > 1 %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}&file_type={{ current_file_type }}&search={{ search }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for p in range(1, total_pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="?page={{ p }}&file_type={{ current_file_type }}&search={{ search }}">
                            {{ p }}
                        </a>
                    </li>
                    {% endfor %}

                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}&file_type={{ current_file_type }}&search={{ search }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                <p class="text-muted mt-3">暂无文件</p>
                <a href="/admin/media/upload" class="btn btn-primary">
                    <i class="bi bi-cloud-upload"></i> 立即上传
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 文件详情模态框 -->
<div class="modal fade" id="fileDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">文件详情</h5>
                <div class="btn-group ms-3" id="previewZoomControls" style="display: none;">
                    <button class="btn btn-sm btn-outline-secondary" onclick="zoomPreview(-0.1)" title="缩小">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="resetZoomPreview()" title="重置">
                        <i class="bi bi-aspect-ratio"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="zoomPreview(0.1)" title="放大">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="downloadPreview()" title="下载">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 预览区域 -->
                <div class="preview-container text-center mb-3 p-3 bg-light rounded" style="min-height: 300px; max-height: 60vh; overflow: auto;">
                    <div id="filePreviewArea" class="d-flex align-items-center justify-content-center" style="transform-origin: center;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 文件信息 -->
                <div id="fileDetailContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- 图片放大查看器 -->
<div class="modal fade" id="imageViewerModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0">
                <div class="btn-group">
                    <button class="btn btn-dark" onclick="viewerZoom(-0.1)">
                        <i class="bi bi-zoom-out text-white"></i>
                    </button>
                    <button class="btn btn-dark" onclick="viewerReset()">
                        <i class="bi bi-aspect-ratio text-white"></i>
                    </button>
                    <button class="btn btn-dark" onclick="viewerZoom(0.1)">
                        <i class="bi bi-zoom-in text-white"></i>
                    </button>
                    <button class="btn btn-dark" onclick="viewerRotate()">
                        <i class="bi bi-arrow-clockwise text-white"></i>
                    </button>
                </div>
                <div class="ms-3 text-white" id="viewerInfo"></div>
                <button type="button" class="btn btn-dark" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg text-white"></i>
                </button>
            </div>
            <div class="modal-body d-flex align-items-center justify-content-center p-0" style="overflow: hidden;">
                <img id="viewerImage" src="" alt="" class="img-fluid" style="max-width: 100%; max-height: 100%; transition: transform 0.2s;">
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <span class="text-muted small" id="viewerFilename"></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ========== 批量选择功能 ==========
function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.media-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
        if (cb.checked) {
            cb.closest('.media-card').classList.add('selected');
        } else {
            cb.closest('.media-card').classList.remove('selected');
        }
    });

    updateBatchActions();
}

// 单个复选框点击
document.querySelectorAll('.media-checkbox').forEach(checkbox => {
    checkbox.addEventListener('click', function(e) {
        e.stopPropagation();
        if (this.checked) {
            this.closest('.media-card').classList.add('selected');
        } else {
            this.closest('.media-card').classList.remove('selected');
        }
        updateBatchActions();
    });
});

// 更新批量操作按钮状态
function updateBatchActions() {
    const checkedCount = document.querySelectorAll('.media-checkbox:checked').length;
    const batchActions = document.getElementById('batchActions');
    const selectedCount = document.getElementById('selectedCount');

    if (checkedCount > 0) {
        batchActions.style.display = 'flex';
        selectedCount.textContent = `已选择 ${checkedCount} 个文件`;
    } else {
        batchActions.style.display = 'none';
        selectedCount.textContent = '';
    }
}

// 获取选中的文件ID列表
function getSelectedIds() {
    return Array.from(document.querySelectorAll('.media-checkbox:checked'))
        .map(cb => cb.value);
}

// 获取选中的文件信息
function getSelectedFiles() {
    return Array.from(document.querySelectorAll('.media-checkbox:checked')).map(cb => {
        const card = cb.closest('.media-card');
        const thumbnail = card.querySelector('.media-thumbnail img');
        return {
            id: cb.value,
            name: card.querySelector('.media-title')?.textContent || '',
            src: thumbnail?.src || ''
        };
    });
}

// 批量复制URL
function batchCopyUrls() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('请先选择文件', 'warning');
        return;
    }

    // 获取文件URLs
    Promise.all(selectedIds.map(id =>
        fetch(`/admin/media/${id}`).then(r => r.json())
    )).then(results => {
        const urls = results
            .filter(r => r.success)
            .map(r => r.file?.url || r.file?.path_original)
            .filter(Boolean)
            .join('\n');

        if (urls) {
            navigator.clipboard.writeText(urls).then(() => {
                showToast(`已复制 ${urls.split('\n').length} 个文件URL`, 'success');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = urls;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast(`已复制 ${urls.split('\n').length} 个文件URL`, 'success');
            });
        }
    });
}

// 批量下载
function batchDownload() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('请先选择文件', 'warning');
        return;
    }

    if (selectedIds.length === 1) {
        // 单个文件直接下载
        const card = document.querySelector(`.media-checkbox[value="${selectedIds[0]}"]`)?.closest('.media-card');
        const img = card?.querySelector('.media-thumbnail img');
        if (img) {
            const link = document.createElement('a');
            link.href = img.src;
            link.download = card.querySelector('.media-title')?.textContent || 'image';
            link.click();
        }
    } else {
        // 多个文件提示用户
        showToast(`准备下载 ${selectedIds.length} 个文件，请稍候...`, 'info');
        // 实际项目中可能需要创建ZIP包
    }
}

// 批量删除
function batchDelete() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('请先选择文件', 'warning');
        return;
    }

    confirmAction(
        '批量删除确认',
        `确定要删除选中的 ${selectedIds.length} 个文件吗？此操作不可恢复！`,
        function() {
            fetch('/media/batch-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ media_ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message || `成功删除 ${selectedIds.length} 个文件`, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || '删除失败', 'error');
                }
            })
            .catch(error => {
                showToast('删除失败，请稍后重试', 'error');
                console.error('Error:', error);
            });
        }
    );
}

// 视图模式切换
const gridViewBtn = document.getElementById('gridViewBtn');
const listViewBtn = document.getElementById('listViewBtn');
const mediaGrid = document.querySelector('.media-grid');

if (gridViewBtn && listViewBtn) {
    gridViewBtn.addEventListener('click', function() {
        mediaGrid.classList.remove('list-view');
        gridViewBtn.classList.add('view-mode-active');
        listViewBtn.classList.remove('view-mode-active');
        localStorage.setItem('mediaViewMode', 'grid');
    });

    listViewBtn.addEventListener('click', function() {
        mediaGrid.classList.add('list-view');
        listViewBtn.classList.add('view-mode-active');
        gridViewBtn.classList.remove('view-mode-active');
        localStorage.setItem('mediaViewMode', 'list');
    });

    // 从本地存储恢复视图模式
    const savedMode = localStorage.getItem('mediaViewMode');
    if (savedMode === 'list') {
        mediaGrid.classList.add('list-view');
        listViewBtn.classList.add('view-mode-active');
        gridViewBtn.classList.remove('view-mode-active');
    }
}

// 查看文件详情
function viewFile(fileId) {
    const modal = new bootstrap.Modal(document.getElementById('fileDetailModal'));
    modal.show();

    fetch(`/admin/media/${fileId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFileDetail(data.file);
            } else {
                document.getElementById('fileDetailContent').innerHTML =
                    '<div class="alert alert-danger">加载失败</div>';
            }
        })
        .catch(error => {
            document.getElementById('fileDetailContent').innerHTML =
                '<div class="alert alert-danger">加载失败</div>';
        });
}

// 显示文件详情
function displayFileDetail(file) {
    let previewHTML = '';
    const zoomControls = document.getElementById('previewZoomControls');

    if (file.file_type === 'image') {
        previewHTML = `
            <div class="position-relative d-inline-block">
                <img src="${file.url}" class="img-fluid mb-3" alt="${file.filename}"
                     style="max-width: 100%; max-height: 50vh; cursor: zoom-in;"
                     onclick="openImageViewer('${file.url}', '${file.filename}')">
                <button class="btn btn-primary btn-sm position-absolute bottom-0 end-0 m-3"
                        onclick="openImageViewer('${file.url}', '${file.filename}')">
                    <i class="bi bi-zoom-in"></i> 放大查看
                </button>
            </div>
        `;
        zoomControls.style.display = 'flex';
    } else if (file.file_type === 'video') {
        previewHTML = `<video src="${file.url}" controls class="w-100 mb-3" style="max-height: 50vh;"></video>`;
        zoomControls.style.display = 'none';
    } else {
        zoomControls.style.display = 'none';
    }

    const html = `
        ${previewHTML}
        <table class="table table-sm">
            <tr><th style="width: 120px;">文件名</th><td>${file.filename}</td></tr>
            <tr><th>文件类型</th><td>${file.file_type}</td></tr>
            <tr><th>MIME 类型</th><td>${file.mime_type}</td></tr>
            <tr><th>文件大小</th><td>${file.size}</td></tr>
            ${file.width ? `<tr><th>尺寸</th><td>${file.width} × ${file.height} px</td></tr>` : ''}
            <tr><th>URL</th><td><code class="small">${file.url || file.path_original}</code></td></tr>
            <tr><th>上传时间</th><td>${new Date(file.created_at).toLocaleString('zh-CN')}</td></tr>
            <tr><th>使用次数</th><td>${file.usage_count}</td></tr>
            <tr><th>查看次数</th><td>${file.view_count}</td></tr>
            <tr><th>下载次数</th><td>${file.download_count}</td></tr>
        </table>
        <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" onclick="copyMediaUrl('${file.url || file.path_original}')">
                <i class="bi bi-link-45deg"></i> 复制URL
            </button>
            <a href="${file.url || file.path_original}" download="${file.filename}" class="btn btn-outline-secondary">
                <i class="bi bi-download"></i> 下载文件
            </a>
        </div>
    `;

    document.getElementById('fileDetailContent').innerHTML = html;
    window.currentPreviewFile = file;
}

// 复制媒体URL
function copyMediaUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
        showToast('URL已复制到剪贴板', 'success');
    }).catch(() => {
        const textarea = document.createElement('textarea');
        textarea.value = url;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('URL已复制到剪贴板', 'success');
    });
}

// 预览缩放变量
let previewScale = 1;

// 预览缩放
function zoomPreview(delta) {
    previewScale = Math.max(0.1, Math.min(3, previewScale + delta));
    const previewImg = document.querySelector('#filePreviewArea img');
    if (previewImg) {
        previewImg.style.transform = `scale(${previewScale})`;
    }
}

// 重置预览缩放
function resetZoomPreview() {
    previewScale = 1;
    const previewImg = document.querySelector('#filePreviewArea img');
    if (previewImg) {
        previewImg.style.transform = 'scale(1)';
    }
}

// 下载预览文件
function downloadPreview() {
    if (window.currentPreviewFile) {
        const link = document.createElement('a');
        link.href = window.currentPreviewFile.url || window.currentPreviewFile.path_original;
        link.download = window.currentPreviewFile.filename;
        link.click();
    }
}

// ========== 图片放大查看器 ==========
let viewerZoomLevel = 1;
let viewerRotation = 0;

function openImageViewer(url, filename) {
    const modal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
    const img = document.getElementById('viewerImage');
    img.src = url;
    img.style.transform = 'scale(1) rotate(0deg)';
    viewerZoomLevel = 1;
    viewerRotation = 0;
    document.getElementById('viewerInfo').textContent = '100%';
    document.getElementById('viewerFilename').textContent = filename;
    modal.show();
}

function viewerZoom(delta) {
    viewerZoomLevel = Math.max(0.1, Math.min(5, viewerZoomLevel + delta));
    updateViewerImage();
}

function viewerReset() {
    viewerZoomLevel = 1;
    viewerRotation = 0;
    updateViewerImage();
}

function viewerRotate() {
    viewerRotation = (viewerRotation + 90) % 360;
    updateViewerImage();
}

function updateViewerImage() {
    const img = document.getElementById('viewerImage');
    img.style.transform = `scale(${viewerZoomLevel}) rotate(${viewerRotation}deg)`;
    document.getElementById('viewerInfo').textContent = Math.round(viewerZoomLevel * 100) + '%';
}

// 鼠标滚轮缩放
document.getElementById('imageViewerModal')?.addEventListener('shown.bs.modal', function() {
    const img = document.getElementById('viewerImage');
    img.addEventListener('wheel', function(e) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        viewerZoom(delta);
    });
});

// 删除单个文件
function deleteFile(fileId) {
    if (!confirm('确定要删除这个文件吗？此操作不可恢复！')) {
        return;
    }

    fetch(`/admin/media/${fileId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('删除成功', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        showToast('删除失败', 'error');
        console.error('Error:', error);
    });
}

// Toast 提示
function showToast(message, type = 'info') {
    // 简单的 Toast 实现
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : 'success'} position-fixed top-0 start-50 translate-middle-x mt-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ========== 键盘快捷键 ==========
document.addEventListener('keydown', function(e) {
    // 防止在输入框中触发
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
    }

    const selectedIds = getSelectedIds();

    // Ctrl + A 全选
    if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        toggleSelectAll();
    }

    // 删除选中
    if (e.key === 'Delete') {
        if (selectedIds.length > 0) {
            e.preventDefault();
            batchDelete();
        }
    }

    // C 复制URL
    if (e.key.toLowerCase() === 'c' && !e.ctrlKey && !e.metaKey) {
        if (selectedIds.length > 0) {
            e.preventDefault();
            batchCopyUrls();
        }
    }

    // Enter 查看详情
    if (e.key === 'Enter') {
        if (selectedIds.length === 1) {
            e.preventDefault();
            viewFile(selectedIds[0]);
        }
    }
});

// ========== 选择模式功能 ==========
const selectMode = {{ 'true' if select_mode else 'false' }};

if (selectMode) {
    // 隐藏不需要的元素
    document.getElementById('selectAllBtn').style.display = 'none';
    document.getElementById('batchActions').style.display = 'none';

    // 修改媒体卡片点击事件用于选择
    document.querySelectorAll('.media-card').forEach(card => {
        const checkbox = card.querySelector('.media-checkbox');
        if (checkbox) {
            const fileId = checkbox.value;
            const fileName = card.querySelector('.media-title')?.textContent || '';

            card.style.cursor = 'pointer';
            card.addEventListener('click', function(e) {
                // 如果点击的是操作按钮，不触发选择
                if (e.target.closest('.media-actions')) return;

                selectMedia(fileId, fileName);
            });
        }
    });

    // 选择媒体文件
    function selectMedia(fileId, fileName) {
        // 检查是否是图片
        const card = document.querySelector(`.media-checkbox[value="${fileId}"]`)?.closest('.media-card');
        const isImage = card?.querySelector('.media-thumbnail img') !== null;

        if (!isImage) {
            showToast('请选择图片文件', 'warning');
            return;
        }

        // 获取媒体信息
        fetch(`/admin/media/${fileId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const file = data.file;

                    // 尝试调用父窗口的回调函数
                    if (window.opener && window.opener.selectMediaCallback) {
                        window.opener.selectMediaCallback({
                            id: file.id,
                            name: file.filename,
                            url: file.url,
                            width: file.width,
                            height: file.height
                        });
                        window.close();
                    } else if (window.parent && window.parent.selectMediaCallback) {
                        // 对于 iframe 内嵌情况
                        window.parent.selectMediaCallback({
                            id: file.id,
                            name: file.filename,
                            url: file.url,
                            width: file.width,
                            height: file.height
                        });
                        window.close();
                    } else {
                        // 没有回调函数，显示选择结果
                        alert(`已选择图片:\nID: ${file.id}\n文件名: ${file.filename}\nURL: ${file.url}`);

                        // 复制到剪贴板
                        navigator.clipboard.writeText(file.id.toString()).then(() => {
                            showToast('图片 ID 已复制到剪贴板', 'success');
                        }).catch(() => {
                            showToast(`图片 ID: ${file.id}`, 'info');
                        });
                    }
                }
            })
            .catch(error => {
                console.error('获取媒体信息失败:', error);
                showToast('选择失败，请重试', 'error');
            });
    }
}

// ========== 拖拽上传功能 ==========
const dropzone = document.getElementById('dropzoneArea');
const dropzoneInput = document.getElementById('dropzoneInput');
const uploadProgress = document.getElementById('uploadProgress');
const uploadList = document.getElementById('uploadList');

// 点击打开文件选择框
dropzone.addEventListener('click', function() {
    dropzoneInput.click();
});

// 拖拽进入
dropzone.addEventListener('dragenter', function(e) {
    e.preventDefault();
    e.stopPropagation();
    dropzone.classList.add('dragover');
});

// 拖拽悬停
dropzone.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    dropzone.classList.add('dragover');
});

// 拖拽离开
dropzone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!dropzone.contains(e.relatedTarget)) {
        dropzone.classList.remove('dragover');
    }
});

// 放置文件
dropzone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    dropzone.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFiles(files);
    }
});

// 文件选择变化
dropzoneInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        handleFiles(this.files);
    }
});

// 处理文件上传
function handleFiles(files) {
    uploadProgress.classList.add('active');

    Array.from(files).forEach(file => {
        // 验证文件类型
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
        if (!allowedTypes.includes(file.type)) {
            addUploadItem(file.name, false, '不支持的文件类型');
            return;
        }

        // 验证文件大小 (10MB)
        if (file.size > 10 * 1024 * 1024) {
            addUploadItem(file.name, false, '文件超过 10MB 限制');
            return;
        }

        // 添加上传项
        const uploadId = 'upload-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        addUploadItem(file.name, null, '', uploadId);

        // 上传文件
        uploadFile(file, uploadId);
    });
}

// 添加上传项
function addUploadItem(fileName, success, message, uploadId) {
    const item = document.createElement('div');
    item.className = 'upload-item';
    item.id = uploadId || 'upload-' + Date.now();

    let statusHtml = '';
    if (success === null) {
        statusHtml = '<div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div><span>上传中...</span>';
    } else if (success) {
        statusHtml = '<i class="bi bi-check-circle text-success me-2"></i><span class="upload-item-success">' + message + '</span>';
    } else {
        statusHtml = '<i class="bi bi-x-circle text-danger me-2"></i><span class="upload-item-error">' + message + '</span>';
    }

    item.innerHTML = `
        <div class="upload-item-name">${fileName}</div>
        <div class="d-flex align-items-center">${statusHtml}</div>
    `;

    uploadList.appendChild(item);
}

// 上传文件
function uploadFile(file, uploadId) {
    const formData = new FormData();
    formData.append('file', file);

    fetch('/admin/media/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const item = document.getElementById(uploadId);
        if (data.success) {
            item.innerHTML = `
                <div class="upload-item-name">${file.name}</div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <span class="upload-item-success">上传成功</span>
                </div>
            `;
            // 延迟刷新页面
            setTimeout(() => location.reload(), 1500);
        } else {
            item.innerHTML = `
                <div class="upload-item-name">${file.name}</div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-x-circle text-danger me-2"></i>
                    <span class="upload-item-error">${data.message || '上传失败'}</span>
                </div>
            `;
        }
    })
    .catch(error => {
        const item = document.getElementById(uploadId);
        item.innerHTML = `
            <div class="upload-item-name">${file.name}</div>
            <div class="d-flex align-items-center">
                <i class="bi bi-x-circle text-danger me-2"></i>
                <span class="upload-item-error">网络错误，上传失败</span>
            </div>
        `;
        console.error('Upload error:', error);
    });
}

// 清空上传进度
function clearUploadProgress() {
    uploadList.innerHTML = '';
    uploadProgress.classList.remove('active');
    dropzoneInput.value = '';
}

// ========== 媒体库增强功能 ==========
document.addEventListener('DOMContentLoaded', function() {
    initFileTypeChart();
    loadStorageInfo();
    loadRecentUploads();
});

// 初始化文件类型图表
function initFileTypeChart() {
    const ctx = document.getElementById('fileTypeChart');
    if (!ctx) return;

    const total = {{ total_files }};
    const images = {{ total_images }};
    const videos = {{ total_videos }};
    const docs = {{ total_documents }};
    const others = total - images - videos - docs;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['图片', '视频', '文档', '其他'],
            datasets: [{
                data: [images, videos, docs, others],
                backgroundColor: ['#22c55e', '#f59e0b', '#0ea5e9', '#6b7280'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '60%',
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// 加载存储信息
function loadStorageInfo() {
    fetch('/admin/media/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                const totalGB = 10; // 总存储 10GB
                const usedGB = (stats.total_size / (1024 * 1024 * 1024)).toFixed(2);
                const percent = Math.min(100, (stats.total_size / (totalGB * 1024 * 1024 * 1024)) * 100).toFixed(1);

                document.getElementById('storageUsed').textContent = usedGB + ' GB';
                document.getElementById('storagePercent').textContent = percent + '%';

                const barFill = document.getElementById('storageBarFill');
                barFill.style.width = percent + '%';

                // 根据使用量设置颜色
                if (percent > 90) {
                    barFill.className = 'storage-bar-fill storage-danger';
                } else if (percent > 70) {
                    barFill.className = 'storage-bar-fill storage-warning';
                } else {
                    barFill.className = 'storage-bar-fill bg-success';
                }

                // 更新各类型文件大小
                document.getElementById('imageSize').textContent = formatSize(stats.image_size);
                document.getElementById('videoSize').textContent = formatSize(stats.video_size);
                document.getElementById('docSize').textContent = formatSize(stats.document_size);
            }
        })
        .catch(() => {
            document.getElementById('storageUsed').textContent = '无法计算';
        });
}

// 格式化文件大小
function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// 加载最近上传
function loadRecentUploads() {
    const container = document.getElementById('recentUploads');
    if (!container) return;

    fetch('/admin/media/api/recent?limit=5')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.files && data.files.length > 0) {
                container.innerHTML = data.files.map(file => `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="d-flex align-items-center">
                            <img src="${file.path_thumb || file.path_original}"
                                 alt="${file.filename}"
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;"
                                 onerror="this.src='/static/images/placeholder.png'">
                            <div class="ms-2 flex-grow-1">
                                <div class="small text-truncate" title="${file.filename_original}">${file.filename_original}</div>
                                <div class="text-muted small">${new Date(file.created_at).toLocaleDateString('zh-CN')}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="text-center text-muted py-3">暂无上传记录</div>';
            }
        })
        .catch(() => {
            container.innerHTML = '<div class="text-center text-muted py-3">加载失败</div>';
        });
}
</script>
{% endblock %}
