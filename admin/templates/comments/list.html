{% extends "base.html" %}

{% block title %}评论管理 - 博文教育管理后台{% endblock %}

{% block content %}
<!-- 面包屑导航 -->
<nav aria-label="breadcrumb" class="mb-3 animate-fade-in">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin"><i class="bi bi-house-door me-1"></i>首页</a></li>
        <li class="breadcrumb-item active" aria-current="page">评论管理</li>
    </ol>
</nav>

<!-- 页面标题区 -->
<div class="page-header animate-fade-in">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="bi bi-chat-dots text-primary me-2"></i>评论管理
            </h1>
            <p class="page-subtitle">管理用户评论，支持审核、回复、删除等操作</p>
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary-light border-0">
            <div class="card-body text-center">
                <div class="display-6 fw-bold text-primary">{{ total }}</div>
                <div class="text-muted">评论总数</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning-light border-0">
            <div class="card-body text-center">
                <div class="display-6 fw-bold text-warning">{{ pending }}</div>
                <div class="text-muted">待审核</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success-light border-0">
            <div class="card-body text-center">
                <div class="display-6 fw-bold text-success">{{ approved }}</div>
                <div class="text-muted">已通过</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger-light border-0">
            <div class="card-body text-center">
                <div class="display-6 fw-bold text-danger">{{ rejected }}</div>
                <div class="text-muted">已拒绝</div>
            </div>
        </div>
    </div>
</div>

<!-- 筛选器 -->
<div class="card mb-4 animate-fade-in">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">状态筛选</label>
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">所有状态</option>
                    <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>待审核</option>
                    <option value="approved" {% if current_status == 'approved' %}selected{% endif %}>已通过</option>
                    <option value="rejected" {% if current_status == 'rejected' %}selected{% endif %}>已拒绝</option>
                    <option value="spam" {% if current_status == 'spam' %}selected{% endif %}>垃圾评论</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">类型筛选</label>
                <select name="content_type" class="form-select" onchange="this.form.submit()">
                    <option value="">所有类型</option>
                    <option value="post" {% if current_type == 'post' %}selected{% endif %}>文章评论</option>
                    <option value="product" {% if current_type == 'product' %}selected{% endif %}>产品评论</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">关键词搜索</label>
                <input type="text" name="keyword" class="form-control" placeholder="搜索评论者或内容"
                       value="{{ current_keyword or '' }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i>搜索
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 评论列表 -->
<div class="card animate-fade-in">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            评论列表
            <span class="badge bg-secondary ms-2">{{ total }}</span>
        </h5>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-success" onclick="batchAction('approve')">
                <i class="bi bi-check-circle me-1"></i>批量通过
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="batchAction('delete')">
                <i class="bi bi-trash me-1"></i>批量删除
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        {% if comments %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 120px;">评论者</th>
                        <th>评论内容</th>
                        <th style="width: 100px;">类型</th>
                        <th style="width: 100px;">状态</th>
                        <th style="width: 150px;">时间</th>
                        <th style="width: 150px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comment in comments %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input comment-checkbox" value="{{ comment.id }}">
                        </td>
                        <td>
                            <div class="fw-medium">{{ comment.author_name }}</div>
                            <div class="text-muted small">{{ comment.author_email or '' }}</div>
                        </td>
                        <td>
                            <div class="comment-content">{{ comment.content }}</div>
                            {% if comment.reply_content %}
                            <div class="reply-content mt-2 p-2 bg-light rounded small">
                                <i class="bi bi-reply me-1"></i>{{ comment.reply_content }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if comment.content_type == 'post' %}
                            <span class="badge bg-primary">文章评论</span>
                            {% else %}
                            <span class="badge bg-success">产品评论</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if comment.status == 'pending' %}
                            <span class="badge bg-warning">待审核</span>
                            {% elif comment.status == 'approved' %}
                            <span class="badge bg-success">已通过</span>
                            {% elif comment.status == 'rejected' %}
                            <span class="badge bg-danger">已拒绝</span>
                            {% elif comment.status == 'spam' %}
                            <span class="badge bg-secondary">垃圾</span>
                            {% endif %}
                        </td>
                        <td class="text-muted small">
                            {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if comment.status == 'pending' %}
                                <button class="btn btn-outline-success" onclick="approveComment({{ comment.id }})" title="通过">
                                    <i class="bi bi-check"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="rejectComment({{ comment.id }})" title="拒绝">
                                    <i class="bi bi-x"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-primary" onclick="replyComment({{ comment.id }})" title="回复">
                                    <i class="bi bi-reply"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteComment({{ comment.id }})" title="删除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="bi bi-chat-dots fs-1 d-block mb-2"></i>
            <p class="mb-0">暂无评论</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 回复模态框 -->
<div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">回复评论</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="replyCommentId">
                <div class="mb-3">
                    <label class="form-label">回复内容</label>
                    <textarea id="replyContent" class="form-control" rows="4" placeholder="输入回复内容..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveReply()">发送回复</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    document.querySelectorAll('.comment-checkbox').forEach(cb => cb.checked = selectAll.checked);
}

function getSelectedIds() {
    const ids = [];
    document.querySelectorAll('.comment-checkbox:checked').forEach(cb => ids.push(parseInt(cb.value)));
    return ids;
}

function approveComment(id) {
    fetch(`/admin/comments/${id}/approve`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('success', '已通过审核', '成功');
                setTimeout(() => location.reload(), 1000);
            }
        });
}

function rejectComment(id) {
    fetch(`/admin/comments/${id}/reject`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('success', '已拒绝', '成功');
                setTimeout(() => location.reload(), 1000);
            }
        });
}

function deleteComment(id) {
    confirmAction(
        '确认删除',
        '确定要删除这条评论吗？',
        function() {
            fetch(`/admin/comments/${id}/delete`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', '已删除', '成功');
                        setTimeout(() => location.reload(), 1000);
                    }
                });
        }
    );
}

function replyComment(id) {
    document.getElementById('replyCommentId').value = id;
    document.getElementById('replyContent').value = '';
    const modal = new bootstrap.Modal(document.getElementById('replyModal'));
    modal.show();
}

function saveReply() {
    const id = document.getElementById('replyCommentId').value;
    const content = document.getElementById('replyContent').value.trim();

    if (!content) {
        showToast('warning', '请输入回复内容', '提示');
        return;
    }

    fetch(`/admin/comments/${id}/reply`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('success', '回复成功', '成功');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('danger', data.message, '错误');
        }
    });
}

function batchAction(action) {
    const ids = getSelectedIds();
    if (ids.length === 0) {
        showToast('warning', '请先选择评论', '提示');
        return;
    }

    const actionNames = {
        'approve': '通过审核',
        'reject': '拒绝',
        'spam': '标记为垃圾',
        'delete': '删除'
    };

    confirmAction(
        `批量${actionNames[action]}`,
        `确定要${actionNames[action]}选中的 ${ids.length} 条评论吗？`,
        function() {
            fetch('/admin/comments/batch-action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment_ids: ids, action })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message, '成功');
                    setTimeout(() => location.reload(), 1000);
                }
            });
        }
    );
}
</script>

<style>
.comment-content {
    max-width: 400px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.reply-content {
    border-left: 3px solid #0d6efd;
}
</style>
{% endblock %}
